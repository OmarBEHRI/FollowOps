{% load static %}
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  {% if edit_mode %}
  <title>FlowOps - Modifier un Projet</title>
  {% else %}
  <title>FlowOps - Créer un Projet</title>
  {% endif %}
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?display=swap&family=Inter:wght@400;500;700;900&family=Noto+Sans:wght@400;500;700;900">
  <link rel="icon" type="image/x-icon" href="data:image/x-icon;base64,">
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>

  <style>
    :root {
        --primary-color: #A08D80;
        --secondary-color: #D4CCC1;
        --text-color-dark: #3F3C3A;
        --text-color-medium: #6E6864;
        --text-color-light: #9C9591;
        --bg-light: #FBF9F7;
        --bg-white: #FFFFFF;
        --border-color: #EBE5E0;
        --status-active-bg: #EAE6DF;
        --status-active-text: #6E6864;
        --status-inactive-bg: #F7EAE3;
        --status-inactive-text: #A08D80;
        --nav-link-color: #191610;
        --nav-link-hover-bg: #f1efe9;
        --nav-link-active-bg: #f1efe9;
        --nav-link-active-color: #191610;
        --button-bg-light: #F0EDE9;
        --shadow-light: rgba(0, 0, 0, 0.03);
        --accent-color: #8B7355;
        --success-color: #10B981;
        --warning-color: #F59E0B;
    }

    .nav-link {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 0.75rem;
        color: var(--nav-link-color);
        font-size: 0.875rem;
        font-weight: 500;
        border-radius: 9999px;
        transition: background-color 0.2s ease, color 0.2s ease;
        white-space: nowrap;
        text-decoration: none;
    }

    .nav-link:hover {
        background-color: var(--nav-link-hover-bg);
    }

    .nav-link-active {
        background-color: var(--nav-link-active-bg);
        color: var(--nav-link-active-color);
    }

    /* Styles améliorés pour les formulaires */
    .form-section {
        background: var(--bg-white);
        border-radius: 1rem;
        padding: 2rem;
        margin-bottom: 2rem;
        border: 1px solid var(--border-color);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        transition: all 0.3s ease;
    }

    .form-section:hover {
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.08);
        transform: translateY(-2px);
        border-color: var(--primary-color);
    }

    .section-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid var(--border-color);
    }

    .section-icon {
        width: 2.5rem;
        height: 2.5rem;
        background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
        border-radius: 0.75rem;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
    }

    .section-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--text-color-dark);
        margin: 0;
    }

    .section-subtitle {
        font-size: 0.875rem;
        color: var(--text-color-medium);
        margin: 0;
    }

    .form-group {
        margin-bottom: 1.5rem;
        display: flex;
        flex-direction: column;
        height: 100%;
    }

    .form-label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: var(--text-color-dark);
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.025em;
        min-height: 1.25rem;
    }

    .form-control {
        width: 100%;
        padding: 0.875rem 1rem;
        border: 2px solid var(--border-color);
        border-radius: 0.5rem;
        background-color: var(--bg-white);
        color: var(--text-color-dark);
        font-size: 0.875rem;
        transition: all 0.2s ease;
        outline: none;
    }

    /* Styles spécifiques pour les champs numériques */
    .form-control[type="number"] {
        -webkit-appearance: none;
        -moz-appearance: textfield;
        appearance: none;
        padding-right: 2.5rem;
    }

    /* Restaurer les flèches d'ajustement pour WebKit */
    .form-control[type="number"]::-webkit-outer-spin-button,
    .form-control[type="number"]::-webkit-inner-spin-button {
        -webkit-appearance: inner-spin-button;
        opacity: 1;
        height: 100%;
        width: 20px;
        cursor: pointer;
        background: var(--bg-light);
        border-left: 1px solid var(--border-color);
    }

    /* Améliorer l'apparence des flèches au survol */
    .form-control[type="number"]::-webkit-outer-spin-button:hover,
    .form-control[type="number"]::-webkit-inner-spin-button:hover {
        background: var(--primary-color);
        color: white;
    }

    .form-control:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(160, 141, 128, 0.1);
        transform: translateY(-1px);
    }

    .form-control:hover {
        border-color: var(--text-color-light);
    }

    .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        padding: 0.875rem 1.5rem;
        border-radius: 0.5rem;
        font-weight: 600;
        font-size: 0.875rem;
        text-decoration: none;
        cursor: pointer;
        transition: all 0.2s ease;
        border: none;
        outline: none;
    }

    .btn-primary {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);
        color: white;
        box-shadow: 0 4px 6px -1px rgba(160, 141, 128, 0.25);
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgba(160, 141, 128, 0.3);
    }

    .btn-secondary {
        background: var(--button-bg-light);
        color: var(--text-color-dark);
        border: 1px solid var(--border-color);
    }

    .btn-secondary:hover {
        background: var(--secondary-color);
        transform: translateY(-1px);
    }


  </style>
</head>
<body class="relative flex size-full min-h-screen flex-col bg-[#fbfaf9] group/design-root overflow-x-hidden font-['Inter','Noto_Sans',sans-serif]">
  <div class="layout-container flex h-full grow flex-col">
    <div class="w-full px-6 py-2">
      <main class="layout-content-container flex flex-col max-w-full w-full flex-1">
        <!-- Header avec navigation FollowOps -->
        <header class="flex flex-col border-b border-solid border-b-[#f1efe9] px-10 py-3">
          <div class="flex items-center justify-between whitespace-nowrap pb-3">
            <div class="flex items-center gap-4 text-[#191610] flex-1">
              <div class="size-4">
                <svg viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M36.7273 44C33.9891 44 31.6043 39.8386 30.3636 33.69C29.123 39.8386 26.7382 44 24 44C21.2618 44 18.877 39.8386 17.6364 33.69C16.3957 39.8386 14.0109 44 11.2727 44C7.25611 44 4 35.0457 4 24C4 12.9543 7.25611 4 11.2727 4C14.0109 4 16.3957 8.16144 17.6364 14.31C18.877 8.16144 21.2618 4 24 4C26.7382 4 29.123 8.16144 30.3636 14.31C31.6043 8.16144 33.9891 4 36.7273 4C40.7439 4 44 12.9543 44 24C44 35.0457 40.7439 44 36.7273 44Z" fill="currentColor"></path>
                </svg>
              </div>
              <h2 class="text-lg font-bold leading-tight tracking-[-0.015em] mr-6">FlowOps</h2>
              <nav class="flex items-center gap-4">
                <a href="/dashboard/" class="nav-link">Tableau de bord</a>
                <a href="/ressources/" class="nav-link">Ressources</a>
                <a href="/projects/" class="nav-link nav-link-active">Projets</a>
                <a href="/tickets/" class="nav-link">Tickets</a>
                {% if user.appRole == 'ADMIN' %}
                <a href="/admin/password-resets/" class="nav-link">
                    <span>Mots de passe</span>
                </a>
                {% endif %}
              </nav>
            </div>
          </div>
        </header>
        
        <!-- Titre principal -->
        <div class="w-full px-6 py-8">
          <div class="flex justify-between items-center mb-8">
            <div>
              {% if edit_mode %}
              <h1 class="text-3xl font-bold text-[#191610] mb-2">Modifier le projet</h1>
              <p class="text-[#6E6864]">Modifiez les informations de votre projet</p>
              {% else %}
              <h1 class="text-3xl font-bold text-[#191610] mb-2">Créer un nouveau projet</h1>
              <p class="text-[#6E6864]">Remplissez les informations pour créer votre projet</p>
              {% endif %}
            </div>
            <div class="flex items-center gap-3">
              {% if edit_mode %}
              <a href="{% url 'projectDetails' pk=project.id %}" class="btn btn-secondary">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                </svg>
                Retour au projet
              </a>
              {% else %}
              <a href="{% url 'projects' %}" class="btn btn-secondary">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                </svg>
                Retour aux projets
              </a>
              {% endif %}
            </div>
          </div>

          <!-- Formulaire principal -->
          <form method="post" class="space-y-6 w-full">
            {% csrf_token %}
            
            <!-- Affichage des erreurs de validation -->
            {% if form.errors %}
            <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
              <div class="flex items-center mb-2">
                <svg class="w-5 h-5 text-red-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <h3 class="text-red-800 font-medium">Erreurs de validation</h3>
              </div>
              <ul class="text-red-700 text-sm space-y-1">
                {% for field, errors in form.errors.items %}
                  {% for error in errors %}
                    <li>{{ field|capfirst }} : {{ error }}</li>
                  {% endfor %}
                {% endfor %}
              </ul>
            </div>
            {% endif %}
            
            <!-- Section 1: Informations générales -->
            <div class="form-section animate-fade-in-up">
              <div class="section-header">
                <div class="section-icon">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                </div>
                <div>
                  <h2 class="section-title">Informations générales</h2>
                  <p class="section-subtitle">Définissez les caractéristiques principales du projet</p>
                </div>
              </div>
              
              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Titre du projet -->
                <div class="form-group">
                    <label for="id_title" class="form-label">{{ form.title.label }}</label>
                    <div class="member-search-container">
                        <div class="relative">
                            <input 
                                type="text" 
                                id="id_title" 
                                name="title"
                                placeholder="Nom du projet..."
                                class="member-search-input"
                                value="{{ form.title.value|default:'' }}"
                                required
                            >
                            <svg class="search-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                        </div>
                    </div>
                </div>
                
                <!-- Type de projet -->
                <div class="form-group">
                    <label for="id_type" class="form-label">{{ form.type.label }}</label>
                    <div class="member-search-container">
                        <div class="relative">
                            <select 
                                id="id_type" 
                                name="type"
                                class="member-search-input"
                            >
                                <option value="">Sélectionner un type...</option>
                                {% for choice in form.type.field.choices %}
                                    <option value="{{ choice.0 }}" {% if form.type.value == choice.0 %}selected{% endif %}>{{ choice.1 }}</option>
                                {% endfor %}
                            </select>
                            <svg class="search-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
                            </svg>
                        </div>
                    </div>
                </div>
                
                <!-- Statut -->
                <div class="form-group">
                    <label for="id_status" class="form-label">{{ form.status.label }}</label>
                    <div class="member-search-container">
                        <div class="relative">
                            <select 
                                id="id_status" 
                                name="status"
                                class="member-search-input"
                            >
                                <option value="">Sélectionner un statut...</option>
                                {% for choice in form.status.field.choices %}
                                    <option value="{{ choice.0 }}" {% if form.status.value == choice.0 %}selected{% endif %}>{{ choice.1 }}</option>
                                {% endfor %}
                            </select>
                            <svg class="search-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                </div>
                
                <!-- Priorité -->
                <div class="form-group">
                    <label for="id_priority" class="form-label">{{ form.priority.label }}</label>
                    <div class="member-search-container">
                        <div class="relative">
                            <select 
                                id="id_priority" 
                                name="priority"
                                class="member-search-input"
                            >
                                <option value="">Sélectionner une priorité...</option>
                                {% for choice in form.priority.field.choices %}
                                    <option value="{{ choice.0 }}" {% if form.priority.value == choice.0 %}selected{% endif %}>{{ choice.1 }}</option>
                                {% endfor %}
                            </select>
                            <svg class="search-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                            </svg>
                        </div>
                    </div>
                </div>
                
                <!-- Chef de projet -->
                <div class="form-group">
                    <label for="id_project_manager" class="form-label">{{ form.project_manager.label }}</label>
                    <div class="member-search-container">
                        <div class="relative">
                            <select 
                                id="id_project_manager" 
                                name="project_manager"
                                class="member-search-input"
                            >
                                <option value="">Sélectionner un chef de projet...</option>
                                {% for choice in form.project_manager.field.choices %}
                                    <option value="{{ choice.0 }}" {% if form.project_manager.value == choice.0 %}selected{% endif %}>{{ choice.1 }}</option>
                                {% endfor %}
                            </select>
                            <svg class="search-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                            </svg>
                        </div>
                    </div>
                </div>
                
                <!-- Progression -->
                <div class="form-group">
                    <label for="id_progress" class="form-label">{{ form.progress.label }}</label>
                    <div class="member-search-container">
                        <div class="relative">
                            <input 
                                type="number" 
                                id="id_progress" 
                                name="progress"
                                placeholder="0-100%"
                                class="member-search-input"
                                value="{{ form.progress.value|default:'' }}"
                                min="0"
                                max="100"
                            >
                            <svg class="search-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                            </svg>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Description -->
            <div class="form-group">
                <label for="id_description" class="form-label">{{ form.description.label }}</label>
                <div class="member-search-container">
                    <div class="relative">
                        <textarea 
                            id="id_description" 
                            name="description"
                            placeholder="Décrivez votre projet en détail..."
                            class="member-search-input"
                            rows="4"
                            style="resize: vertical; min-height: 100px;"
                        >{{ form.description.value|default:'' }}</textarea>
                        <svg class="search-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="top: 1rem;">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7"></path>
                        </svg>
                    </div>
                </div>
            </div>
            </div>

            <!-- Section 2: Planning et ressources - VERSION AMÉLIORÉE -->
            <div class="form-section animate-fade-in-up" style="animation-delay: 0.1s">
              <div class="section-header">
                <div class="section-icon">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                  </svg>
                </div>
                <div>
                  <h2 class="section-title">Planning et ressources</h2>
                  <p class="section-subtitle">Planifiez les dates et estimez les ressources nécessaires</p>
                </div>
              </div>
              
              <!-- Sous-section: Estimation des charges -->
              <div class="mb-8">
                <h3 class="text-lg font-semibold text-[#3F3C3A] mb-4 flex items-center gap-2">
                  <svg class="w-4 h-4 text-[#A08D80]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                  Estimation des charges
                </h3>
                <div class="bg-[#FBF9F7] p-4 rounded-lg border border-[#EBE5E0]">
                  <div class="planning-field-container">
                    <div class="member-search-container">
                        <div class="relative">
                            <input 
                                type="text" 
                                id="id_estimated_charges" 
                                name="estimated_charges"
                                placeholder="Ex: 15 jours, 120 heures..."
                                class="member-search-input"
                                value="{{ form.estimated_charges.value|default:'' }}"
                            >
                            <svg class="search-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Sous-section: Budget (Admin/Manager seulement) -->
              {% if user.appRole == 'ADMIN' or user.appRole == 'MANAGER' %}
              <div>
                <h3 class="text-lg font-semibold text-[#3F3C3A] mb-4 flex items-center gap-2">
                  <svg class="w-4 h-4 text-[#A08D80]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                  </svg>
                  Budget alloué
                </h3>
                <div class="bg-[#FBF9F7] p-4 rounded-lg border border-[#EBE5E0]">
                  <div class="planning-field-container">
                    <div class="member-search-container">
                        <div class="relative">
                            <input 
                                type="number" 
                                id="id_budget" 
                                name="budget"
                                placeholder="Ex: 50000.00"
                                class="member-search-input"
                                value="{{ form.budget.value|default:'' }}"
                                step="0.01"
                                min="0"
                            >
                            <svg class="search-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                            </svg>
                        </div>
                    </div>
                  </div>
                </div>
              </div>
              {% endif %}
              
              <!-- Sous-section: Planification temporelle -->
              <div>
                <h3 class="text-lg font-semibold text-[#3F3C3A] mb-4 flex items-center gap-2">
                  <svg class="w-4 h-4 text-[#A08D80]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                  </svg>
                  Planification temporelle
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div class="bg-[#FBF9F7] p-4 rounded-lg border border-[#EBE5E0]">
                    <div class="planning-field-container">
                        <div class="member-search-container">
                            <div class="relative">
                                <input 
                                    type="date" 
                                    id="id_expected_start_date" 
                                    name="expected_start_date"
                                    class="member-search-input"
                                    value="{{ form.expected_start_date.value|date:'Y-m-d'|default:'' }}"
                                >
                                <svg class="search-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                </svg>
                            </div>
                        </div>
                    </div>
                  </div>
                  
                  <div class="bg-[#FBF9F7] p-4 rounded-lg border border-[#EBE5E0]">
                    <div class="planning-field-container">
                        <div class="member-search-container">
                            <div class="relative">
                                <input 
                                    type="date" 
                                    id="id_expected_end_date" 
                                    name="expected_end_date"
                                    class="member-search-input"
                                    value="{{ form.expected_end_date.value|date:'Y-m-d'|default:'' }}"
                                >
                                <svg class="search-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </div>
                        </div>
                    </div>
                  </div>
                </div>
                
                <!-- Indicateur de durée calculée -->
                <div class="mt-4 p-3 bg-gradient-to-r from-[#A08D80] to-[#8B7355] rounded-lg text-white" id="duration-indicator" style="display: none;">
                  <div class="flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span class="font-medium">Durée estimée du projet :</span>
                    <span id="calculated-duration" class="font-bold"></span>
                  </div>
                </div>
              </div>
            </div>

<!-- Section 3: Tags avec liste déroulante harmonisée -->
<div class="form-section animate-fade-in-up" style="animation-delay: 0.2s">
  <div class="section-header">
    <div class="section-icon">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.99 1.99 0 013 12V7a4 4 0 014-4z"></path>
      </svg>
    </div>
    <div>
      <h2 class="section-title">Tags</h2>
      <p class="section-subtitle">Sélectionnez ou créez des étiquettes pour votre projet</p>
    </div>
  </div>
  
  <div class="form-group">
    <label for="tag-input" class="form-label">{{ form.tags.label }}</label>
    <div class="tag-input-container">
      <div class="member-search-container">
        <div class="relative">
          <input 
            type="text" 
            id="tag-input" 
            placeholder="Cliquez pour voir les tags disponibles ou tapez pour créer..."
            class="member-search-input"
            autocomplete="off"
          >
          <svg class="search-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.99 1.99 0 013 12V7a4 4 0 014-4z"></path>
          </svg>
        </div>
      </div>
      
      <!-- Liste déroulante harmonisée -->
      <div class="dropdown-menu hidden" id="tag-dropdown">
        <div class="dropdown-header">Tags disponibles</div>
        <div class="dropdown-content" id="tag-list">
          <!-- Les tags seront chargés ici -->
        </div>
      </div>
    </div>
    
    <!-- Affichage des tags sélectionnés -->
    <div class="selected-tags-display" id="selected-tags">
      <!-- Les tags sélectionnés apparaîtront ici -->
    </div>
    
    <!-- Input caché pour le formulaire -->
    {{ form.tags }}
  </div>
</div>

<style>
.tag-input-container {
  position: relative;
}

/* Harmonisation avec les autres dropdowns */
.dropdown-menu {
  position: absolute;
  z-index: 10;
  margin-top: 0.25rem;
  width: 100%;
  border-radius: 0.5rem;
  background-color: white;
  box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
  border: 1px solid var(--border-color);
  max-height: 200px;
  overflow-y: auto;
}

.dropdown-menu.hidden {
  display: none;
}

.dropdown-header {
  padding: 0.75rem 1rem;
  background: var(--bg-light);
  border-bottom: 1px solid var(--border-color);
  font-weight: 600;
  font-size: 0.875rem;
  color: var(--text-color-dark);
  border-radius: 0.5rem 0.5rem 0 0;
}

.dropdown-content {
  max-height: 150px;
  overflow-y: auto;
}

.dropdown-item {
  display: block;
  border-radius: 0.25rem;
  padding: 0.5rem 1rem;
  font-size: 0.875rem;
  color: #191610;
  text-decoration: none;
  transition: background-color 0.2s ease;
  cursor: pointer;
  border-bottom: 1px solid var(--border-color);
}

.dropdown-item:hover {
  background-color: #f1efe9;
}

.dropdown-item:last-child {
  border-bottom: none;
  border-radius: 0 0 0.5rem 0.5rem;
}

.selected-tags-display {
  margin-top: 1rem;
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
}

.selected-tag {
  background: var(--primary-color);
  color: white;
  padding: 0.5rem 0.75rem;
  border-radius: 1rem;
  font-size: 0.875rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.tag-remove {
  background: rgba(255, 255, 255, 0.3);
  border: none;
  color: white;
  cursor: pointer;
  border-radius: 50%;
  width: 18px;
  height: 18px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
}

.tag-remove:hover {
  background: rgba(255, 255, 255, 0.5);
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const tagInput = document.getElementById('tag-input');
  const tagDropdown = document.getElementById('tag-dropdown');
  const tagList = document.getElementById('tag-list');
  const selectedTagsContainer = document.getElementById('selected-tags');
  const hiddenInput = document.querySelector('input[name="tags"]');
  
  let availableTags = [];
  let selectedTags = [];
  
  // Charger les tags disponibles
  function loadTags() {
    fetch('/projects/api/tags/all/')
      .then(response => response.json())
      .then(data => {
        availableTags = data.tags;
        displayTags(availableTags);
      })
      .catch(error => console.error('Erreur:', error));
  }
  
  // Afficher les tags dans la liste déroulante (style harmonisé)
  function displayTags(tags) {
    tagList.innerHTML = '';
    tags.forEach(tag => {
      const tagElement = document.createElement('div');
      tagElement.className = 'dropdown-item';
      tagElement.textContent = tag.name;
      tagElement.onclick = () => selectTag(tag);
      tagList.appendChild(tagElement);
    });
  }
  
  // Sélectionner un tag
  function selectTag(tag) {
    if (!selectedTags.find(t => t.id === tag.id)) {
      selectedTags.push(tag);
      updateSelectedTags();
      tagDropdown.classList.add('hidden');
      tagInput.value = '';
    }
  }
  
  // Supprimer un tag
  function removeTag(tagId) {
    selectedTags = selectedTags.filter(tag => tag.id !== tagId);
    updateSelectedTags();
  }
  
  // Mettre à jour l'affichage des tags sélectionnés
  function updateSelectedTags() {
    selectedTagsContainer.innerHTML = '';
    selectedTags.forEach(tag => {
      const tagElement = document.createElement('div');
      tagElement.className = 'selected-tag';
      tagElement.innerHTML = `
        <span>${tag.name}</span>
        <button type="button" class="tag-remove" onclick="removeTag(${tag.id})">
          ×
        </button>
      `;
      selectedTagsContainer.appendChild(tagElement);
    });
    
    // Mettre à jour l'input caché
    if (hiddenInput) {
      hiddenInput.value = selectedTags.map(tag => tag.id).join(',');
    }
  }
  
  // Événements harmonisés avec les autres dropdowns
  tagInput.addEventListener('click', function() {
    loadTags();
    tagDropdown.classList.remove('hidden');
  });
  
  tagInput.addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase();
    const filteredTags = availableTags.filter(tag => 
      tag.name.toLowerCase().includes(searchTerm)
    );
    displayTags(filteredTags);
    tagDropdown.classList.remove('hidden');
  });
  
  // Fermer la liste au clic extérieur (comme les autres dropdowns)
  document.addEventListener('click', function(e) {
    if (!tagInput.contains(e.target) && !tagDropdown.contains(e.target)) {
      tagDropdown.classList.add('hidden');
    }
  });
  
  // Fonction globale pour supprimer un tag
  window.removeTag = removeTag;
});
</script>

            <style>
            .tags-container-enhanced {
              background: linear-gradient(135deg, var(--bg-light) 0%, #f8f6f3 100%);
              border-radius: 1rem;
              padding: 1.5rem;
              border: 1px solid var(--border-color);
              position: relative;
              overflow: hidden;
            }

            .tags-container-enhanced::before {
              content: '';
              position: absolute;
              top: -50%;
              left: -50%;
              width: 200%;
              height: 200%;
              background: radial-gradient(circle, rgba(160, 141, 128, 0.03) 0%, transparent 70%);
              animation: rotate-bg 20s linear infinite;
              pointer-events: none;
            }

            @keyframes rotate-bg {
              from { transform: rotate(0deg); }
              to { transform: rotate(360deg); }
            }

            .tags-input-enhanced {
              position: relative;
              margin-bottom: 1.5rem;
            }

            .input-glow-effect {
              position: absolute;
              top: -2px;
              left: -2px;
              right: -2px;
              bottom: -2px;
              background: linear-gradient(45deg, var(--primary-color), var(--accent-color), var(--primary-color));
              border-radius: 0.75rem;
              opacity: 0;
              transition: opacity 0.3s ease;
              z-index: 1;
              background-size: 200% 200%;
              animation: gradient-shift 3s ease infinite;
            }

            @keyframes gradient-shift {
              0%, 100% { background-position: 0% 50%; }
              50% { background-position: 100% 50%; }
            }

            .enhanced-input {
              position: relative;
              z-index: 2;
              width: 100%;
              padding: 1rem 1.25rem;
              border: 2px solid var(--border-color);
              border-radius: 0.75rem;
              background: var(--bg-white);
              color: var(--text-color-dark);
              font-size: 0.875rem;
              transition: all 0.3s ease;
              outline: none;
            }

            .enhanced-input:focus {
              border-color: transparent;
              transform: translateY(-2px);
              box-shadow: 0 10px 25px -5px rgba(160, 141, 128, 0.2);
            }

            .enhanced-input:focus + .input-particles {
              opacity: 1;
            }

            .tags-input-enhanced:focus-within .input-glow-effect {
              opacity: 1;
            }

            .input-particles {
              position: absolute;
              top: 0;
              left: 0;
              right: 0;
              bottom: 0;
              pointer-events: none;
              opacity: 0;
              transition: opacity 0.3s ease;
            }

            .input-particles::before,
            .input-particles::after {
              content: '';
              position: absolute;
              width: 4px;
              height: 4px;
              background: var(--primary-color);
              border-radius: 50%;
              animation: float-particles 2s ease-in-out infinite;
            }

            .input-particles::before {
              top: 20%;
              left: 10%;
              animation-delay: 0s;
            }

            .input-particles::after {
              top: 60%;
              right: 15%;
              animation-delay: 1s;
            }

            @keyframes float-particles {
              0%, 100% {
                transform: translateY(0px) scale(1);
                opacity: 0.7;
              }
              50% {
                transform: translateY(-10px) scale(1.2);
                opacity: 1;
              }
            }

            .tags-display-enhanced {
              min-height: 80px;
              background: var(--bg-white);
              border-radius: 0.75rem;
              padding: 1rem;
              border: 2px dashed var(--border-color);
              transition: all 0.3s ease;
              position: relative;
            }

            .tags-display-enhanced.has-tags {
              border-style: solid;
              border-color: var(--primary-color);
              background: linear-gradient(135deg, #faf9f7 0%, var(--bg-white) 100%);
            }

            .tags-placeholder {
              display: flex;
              flex-direction: column;
              align-items: center;
              justify-content: center;
              height: 60px;
              color: var(--text-color-light);
              transition: all 0.3s ease;
            }

            .placeholder-icon {
              font-size: 1.5rem;
              margin-bottom: 0.25rem;
              animation: bounce-gentle 2s ease-in-out infinite;
            }

            @keyframes bounce-gentle {
              0%, 100% { transform: translateY(0px); }
              50% { transform: translateY(-5px); }
            }

            .placeholder-text {
              font-size: 0.75rem;
              text-align: center;
            }

            .tags-grid {
              display: flex;
              flex-wrap: wrap;
              gap: 0.75rem;
              animation: fadeIn 0.5s ease;
            }

            @keyframes fadeIn {
              from { opacity: 0; transform: translateY(10px); }
              to { opacity: 1; transform: translateY(0); }
            }

            .enhanced-tag {
              background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
              color: white;
              padding: 0.5rem 0.75rem;
              border-radius: 1.5rem;
              font-size: 0.75rem;
              font-weight: 600;
              display: inline-flex;
              align-items: center;
              gap: 0.5rem;
              cursor: pointer;
              transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
              position: relative;
              overflow: hidden;
              animation: slideInTag 0.4s ease;
              box-shadow: 0 2px 8px rgba(160, 141, 128, 0.3);
            }

            @keyframes slideInTag {
              from {
                opacity: 0;
                transform: translateX(-20px) scale(0.8);
              }
              to {
                opacity: 1;
                transform: translateX(0) scale(1);
              }
            }

            .enhanced-tag::before {
              content: '';
              position: absolute;
              top: 0;
              left: -100%;
              width: 100%;
              height: 100%;
              background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
              transition: left 0.5s ease;
            }

            .enhanced-tag:hover {
              transform: translateY(-2px) scale(1.05);
              box-shadow: 0 8px 20px rgba(160, 141, 128, 0.4);
            }

            .enhanced-tag:hover::before {
              left: 100%;
            }

            .tag-remove-enhanced {
              background: rgba(255, 255, 255, 0.2);
              border: none;
              color: white;
              cursor: pointer;
              font-size: 0.75rem;
              line-height: 1;
              padding: 0;
              width: 18px;
              height: 18px;
              display: flex;
              align-items: center;
              justify-content: center;
              border-radius: 50%;
              transition: all 0.2s ease;
            }

            .tag-remove-enhanced:hover {
              background: rgba(255, 255, 255, 0.3);
              transform: rotate(90deg) scale(1.1);
            }

            .tags-counter {
              display: flex;
              align-items: center;
              gap: 0.5rem;
              margin-top: 1rem;
              padding: 0.5rem 0.75rem;
              background: var(--status-active-bg);
              border-radius: 0.5rem;
              color: var(--status-active-text);
              font-size: 0.75rem;
              font-weight: 600;
              width: fit-content;
            }

            .counter-icon {
              animation: pulse-counter 2s ease-in-out infinite;
            }

            @keyframes pulse-counter {
              0%, 100% { transform: scale(1); }
              50% { transform: scale(1.1); }
            }

            /* Animation pour le compteur qui change */
            .counter-text {
              transition: all 0.3s ease;
            }

            .counter-update {
              animation: counter-bounce 0.5s ease;
            }

            @keyframes counter-bounce {
              0% { transform: scale(1); }
              50% { transform: scale(1.2); color: var(--primary-color); }
              100% { transform: scale(1); }
            }
            </style>

            <script>
            document.addEventListener('DOMContentLoaded', function() {
              const tagInput = document.getElementById('tag-input-enhanced');
              const tagsDisplay = document.getElementById('selected-tags-enhanced');
              const tagCount = document.getElementById('tag-count');
              const hiddenInput = document.querySelector('input[name="tags"]');
              let tags = [];
              
              function updateTagsDisplay() {
                if (tags.length === 0) {
                  tagsDisplay.innerHTML = `
                    <div class="tags-placeholder">
                      <span class="placeholder-icon">🏷️</span>
                      <span class="placeholder-text">Vos tags apparaîtront ici avec style !</span>
                    </div>
                  `;
                  tagsDisplay.classList.remove('has-tags');
                } else {
                  const tagsHTML = tags.map((tag, index) => `
                    <div class="enhanced-tag" data-index="${index}">
                      <span class="tag-text">${tag}</span>
                      <button type="button" class="tag-remove-enhanced" onclick="removeTagEnhanced(${index})">
                        ×
                      </button>
                    </div>
                  `).join('');
                  
                  tagsDisplay.innerHTML = `<div class="tags-grid">${tagsHTML}</div>`;
                  tagsDisplay.classList.add('has-tags');
                }
                
                // Mettre à jour le compteur avec animation
                const counterText = tagCount.parentElement;
                counterText.classList.add('counter-update');
                tagCount.textContent = tags.length;
                setTimeout(() => counterText.classList.remove('counter-update'), 500);
                
                // Mettre à jour l'input caché
                if (hiddenInput) {
                  hiddenInput.value = tags.join(',');
                }
              }
              
              function addTag(tagText) {
                const trimmedTag = tagText.trim();
                if (trimmedTag && !tags.includes(trimmedTag)) {
                  tags.push(trimmedTag);
                  updateTagsDisplay();
                  
                  // Effet de particules lors de l'ajout
                  createTagParticles();
                }
              }
              
              function createTagParticles() {
                const container = document.querySelector('.tags-container-enhanced');
                for (let i = 0; i < 5; i++) {
                  const particle = document.createElement('div');
                  particle.style.cssText = `
                    position: absolute;
                    width: 4px;
                    height: 4px;
                    background: var(--primary-color);
                    border-radius: 50%;
                    pointer-events: none;
                    z-index: 10;
                    left: ${Math.random() * 100}%;
                    top: ${Math.random() * 100}%;
                    animation: particle-burst 1s ease-out forwards;
                  `;
                  container.appendChild(particle);
                  
                  setTimeout(() => particle.remove(), 1000);
                }
              }
              
              // Ajouter l'animation CSS pour les particules
              const style = document.createElement('style');
              style.textContent = `
                @keyframes particle-burst {
                  0% {
                    opacity: 1;
                    transform: scale(1) translateY(0);
                  }
                  100% {
                    opacity: 0;
                    transform: scale(0.5) translateY(-30px);
                  }
                }
              `;
              document.head.appendChild(style);
              
              window.removeTagEnhanced = function(index) {
                tags.splice(index, 1);
                updateTagsDisplay();
              };
              
              tagInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' || e.key === ',') {
                  e.preventDefault();
                  addTag(this.value);
                  this.value = '';
                }
              });
              
              tagInput.addEventListener('blur', function() {
                if (this.value.trim()) {
                  addTag(this.value);
                  this.value = '';
                }
              });
              
              // Initialiser l'affichage
              updateTagsDisplay();
            });
            </script>

            <!-- Section 4: Membres de l'équipe -->
            <div class="form-section animate-fade-in-up" style="animation-delay: 0.3s">
              <div class="section-header">
                  <div class="section-icon">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path>
                    </svg>
                  </div>
                  <div>
                    <h2 class="section-title">Membres de l'équipe</h2>
                    <p class="section-subtitle">Recherchez et sélectionnez les membres du projet</p>
                  </div>
                </div>
              
              <div class="form-group">
                <!-- Barre de recherche -->
                <div class="member-search-container">
                  <div class="relative">
                    <input 
                      type="text" 
                      id="member-search" 
                      placeholder="Rechercher un membre..."
                      class="member-search-input"
                    >
                    <svg class="search-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                  </div>
                </div>

                <!-- Membres sélectionnés (badges) -->
                <div class="selected-members-container">
                  <div class="selected-members-header">
                    <span class="text-sm font-medium text-[#3F3C3A]">Membres sélectionnés</span>
                    <span class="selected-count">0</span>
                  </div>
                  <div class="selected-members-list" id="selected-members">
                    <!-- Les badges des membres sélectionnés apparaîtront ici -->
                  </div>
                </div>

                <!-- Liste des membres disponibles (tags cliquables) -->
                <div class="available-members-container">
                  <div class="available-members-header">
                    <span class="text-sm font-medium text-[#3F3C3A]">Membres disponibles</span>
                  </div>
                  <div class="members-tags-grid" id="members-grid">
                    {% for member in available_members %}
                    <div class="member-tag" data-member="{{ member.id }}">
                      <div class="member-avatar">
                        <span>{{ member.first_name.0 }}{{ member.last_name.0 }}</span>
                      </div>
                      <span class="member-name">{{ member.first_name }} {{ member.last_name }}</span>
                      <div class="member-role">{{ member.role|default:"Membre" }}</div>
                    </div>
                    {% empty %}
                    <p class="text-gray-500">Aucun membre disponible</p>
                    {% endfor %}
                  </div>
                </div>
                
                <!-- MASQUER le champ Django par défaut -->
                <div style="display: none;">
                  {{ form.members }}
                </div>
              </div>
            </div>

            <style>
            .member-search-container {
              margin-bottom: 0;
              flex: 1;
              display: flex;
              flex-direction: column;
            }

            .member-search-input {
              width: 100%;
              padding: 0.75rem 1rem 0.75rem 2.5rem;
              border: 1px solid var(--border-color);
              border-radius: 0.75rem;
              background: var(--bg-white);
              font-size: 0.875rem;
              transition: all 0.3s ease;
              height: 2.75rem;
              box-sizing: border-box;
            }

            .member-search-input:focus {
              outline: none;
              border-color: var(--primary-color);
              box-shadow: 0 0 0 3px rgba(160, 141, 128, 0.1);
            }

            .search-icon {
              position: absolute;
              left: 0.75rem;
              top: 50%;
              transform: translateY(-50%);
              width: 1rem;
              height: 1rem;
              color: var(--text-color-medium);
              pointer-events: none;
            }

            textarea.member-search-input + .search-icon {
              top: 1rem;
              transform: none;
            }

            select.member-search-input {
              appearance: none;
              background-image: url('data:image/svg+xml;charset=US-ASCII,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 4 5"><path fill="%23666" d="M2 0L0 2h4zm0 5L0 3h4z"/></svg>');
              background-repeat: no-repeat;
              background-position: right 0.7rem center;
              background-size: 0.65rem auto;
              padding-right: 2rem;
            }

            textarea.member-search-input {
              min-height: 100px;
              height: auto;
              resize: vertical;
              padding-top: 0.75rem;
            }

            .grid.grid-cols-1.md\:grid-cols-2.lg\:grid-cols-3 {
              display: grid;
              grid-template-columns: 1fr;
              gap: 1.5rem;
              align-items: start;
            }

            @media (min-width: 768px) {
              .grid.grid-cols-1.md\:grid-cols-2.lg\:grid-cols-3 {
                grid-template-columns: repeat(2, 1fr);
              }
            }

            @media (min-width: 1024px) {
              .grid.grid-cols-1.md\:grid-cols-2.lg\:grid-cols-3 {
                grid-template-columns: repeat(3, 1fr);
              }
            }

            .selected-members-container {
              background: var(--bg-light);
              border: 1px solid var(--border-color);
              border-radius: 0.75rem;
              padding: 1rem;
              margin-bottom: 1.5rem;
              min-height: 4rem;
            }

            .selected-members-header {
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 0.75rem;
            }

            .selected-count {
              background: var(--primary-color);
              color: white;
              padding: 0.25rem 0.5rem;
              border-radius: 1rem;
              font-size: 0.75rem;
              font-weight: 600;
            }

            .selected-members-list {
              display: flex;
              flex-wrap: wrap;
              gap: 0.5rem;
            }

            .selected-member-badge {
              display: flex;
              align-items: center;
              gap: 0.5rem;
              background: var(--primary-color);
              color: white;
              padding: 0.5rem 0.75rem;
              border-radius: 1.5rem;
              font-size: 0.875rem;
              animation: slideIn 0.3s ease;
            }

            .remove-member {
              background: rgba(255, 255, 255, 0.2);
              border: none;
              border-radius: 50%;
              width: 1.25rem;
              height: 1.25rem;
              display: flex;
              align-items: center;
              justify-content: center;
              cursor: pointer;
              transition: background 0.2s ease;
            }

            .remove-member:hover {
              background: rgba(255, 255, 255, 0.3);
            }

            .available-members-container {
              background: var(--bg-white);
              border: 1px solid var(--border-color);
              border-radius: 0.75rem;
              padding: 1rem;
            }

            .available-members-header {
              margin-bottom: 1rem;
              padding-bottom: 0.75rem;
              border-bottom: 1px solid var(--border-color);
            }

            .members-tags-grid {
              display: grid;
              grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
              gap: 1rem;
              max-height: 400px;
              overflow-y: auto;
              padding: 0.5rem;
            }

            .member-tag {
              display: flex;
              align-items: center;
              gap: 0.75rem;
              padding: 1rem;
              border: 2px solid var(--border-color);
              border-radius: 0.75rem;
              cursor: pointer;
              transition: all 0.3s ease;
              background: var(--bg-white);
            }

            .member-tag:hover {
              border-color: var(--primary-color);
              transform: translateY(-2px) scale(1.02);
              box-shadow: 0 8px 20px rgba(160, 141, 128, 0.15);
            }

            .member-tag.selected {
              border-color: var(--primary-color);
              background: linear-gradient(135deg, var(--bg-light) 0%, var(--bg-white) 100%);
              opacity: 0.6;
              pointer-events: none;
            }

            .member-avatar {
              width: 2rem;
              height: 2rem;
              border-radius: 50%;
              background: var(--secondary-color);
              display: flex;
              align-items: center;
              justify-content: center;
              font-weight: 600;
              font-size: 0.75rem;
              color: var(--text-color-dark);
            }

            .member-name {
              font-weight: 500;
              color: var(--text-color-dark);
              font-size: 0.875rem;
            }

            .member-role {
              font-size: 0.75rem;
              color: var(--text-color-medium);
              margin-left: auto;
            }

            @keyframes slideIn {
              from {
                opacity: 0;
                transform: translateX(-10px);
              }
              to {
                opacity: 1;
                transform: translateX(0);
              }
            }

            .member-tag.hidden {
              display: none;
            }
            </style>

            <script>
            document.addEventListener('DOMContentLoaded', function() {
              const searchInput = document.getElementById('member-search');
              const membersGrid = document.getElementById('members-grid');
              const selectedMembersList = document.getElementById('selected-members');
              const selectedCount = document.querySelector('.selected-count');
              const memberTags = document.querySelectorAll('.member-tag');
              
              let selectedMembers = [];

              // Initialisation des membres existants en mode édition
              {% if edit_mode and project.members.all %}
              const existingMembers = [
                {% for member in project.members.all %}
                {
                  id: '{{ member.id }}',
                  name: '{{ member.first_name }} {{ member.last_name }}',
                  role: '{{ member.role|default:"Membre" }}'
                },
                {% endfor %}
              ];
              
              // Pré-remplir les membres sélectionnés
              existingMembers.forEach(member => {
                selectedMembers.push(member);
                createMemberBadge(member.id, member.name);
                
                // Marquer le tag comme sélectionné
                const memberTag = document.querySelector(`[data-member="${member.id}"]`);
                if (memberTag) {
                  memberTag.classList.add('selected');
                }
              });
              
              updateSelectedCount();
              {% endif %}

              // Fonction de recherche
              searchInput.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                memberTags.forEach(tag => {
                  const memberName = tag.querySelector('.member-name').textContent.toLowerCase();
                  const memberRole = tag.querySelector('.member-role').textContent.toLowerCase();
                  
                  if (memberName.includes(searchTerm) || memberRole.includes(searchTerm)) {
                    tag.classList.remove('hidden');
                  } else {
                    tag.classList.add('hidden');
                  }
                });
              });

              // Sélection des membres
              memberTags.forEach(tag => {
                tag.addEventListener('click', function() {
                  if (this.classList.contains('selected')) return;
                  
                  const memberId = this.dataset.member;
                  const memberName = this.querySelector('.member-name').textContent;
                  const memberRole = this.querySelector('.member-role').textContent;
                  
                  // Ajouter à la liste des sélectionnés
                  selectedMembers.push({
                    id: memberId,
                    name: memberName,
                    role: memberRole
                  });
                  
                  // Marquer comme sélectionné
                  this.classList.add('selected');
                  
                  // Créer le badge
                  createMemberBadge(memberId, memberName);
                  
                  // Mettre à jour le compteur
                  updateSelectedCount();
                });
              });

              function createMemberBadge(memberId, memberName) {
                const badge = document.createElement('div');
                badge.className = 'selected-member-badge';
                badge.dataset.member = memberId;
                badge.innerHTML = `
                  <span>${memberName}</span>
                  <button type="button" class="remove-member" onclick="removeMember('${memberId}')">
                    <svg width="12" height="12" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                  </button>
                `;
                selectedMembersList.appendChild(badge);
              }

              window.removeMember = function(memberId) {
                // Supprimer de la liste
                selectedMembers = selectedMembers.filter(member => member.id !== memberId);
                
                // Supprimer le badge
                const badge = document.querySelector(`[data-member="${memberId}"].selected-member-badge`);
                if (badge) badge.remove();
                
                // Démarquer le tag
                const tag = document.querySelector(`[data-member="${memberId}"].member-tag`);
                if (tag) tag.classList.remove('selected');
                
                // Mettre à jour le compteur
                updateSelectedCount();
              };

              function updateSelectedCount() {
                selectedCount.textContent = selectedMembers.length;
              }
            });
            </script>

            <!-- Actions -->
            <div class="form-section animate-fade-in-up" style="animation-delay: 0.4s">
              <div class="flex justify-end items-center gap-4">
                {% if edit_mode %}
                <a href="{% url 'projectDetails' pk=project.id %}" class="btn btn-secondary">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                  </svg>
                  Annuler
                </a>
                <button type="submit" class="btn btn-primary">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                  </svg>
                  Enregistrer les modifications
                </button>
                {% else %}
                <a href="{% url 'projects' %}" class="btn btn-secondary">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                  </svg>
                  Annuler
                </a>
                <button type="submit" class="btn btn-primary">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                  </svg>
                  Créer le projet
                </button>
                {% endif %}
              </div>
            </div>
          </form>
        </div>
      </main>
    </div>
  </div>
  <!-- Avant la fermeture du body -->
  <script>
// JavaScript pour la gestion des tags avec liste de sélection
document.addEventListener('DOMContentLoaded', function() {
  const tagSelector = document.getElementById('tag-selector');
  const addSelectedTagBtn = document.getElementById('add-selected-tag');
  const newTagInput = document.getElementById('new-tag-input');
  const createNewTagBtn = document.getElementById('create-new-tag');
  const selectedTagsContainer = document.getElementById('selected-tags-container');
  const tagsPlaceholder = document.getElementById('tags-placeholder');
  const tagCount = document.getElementById('tag-count');
  const hiddenTagsInput = document.getElementById('id_tags');
  
  let selectedTags = new Set();
  
  // Charger les tags existants
  function loadExistingTags() {
    fetch('/projects/api/tags/all/')
      .then(response => response.json())
      .then(data => {
        tagSelector.innerHTML = '<option value="">Choisir un tag existant...</option>';
        data.tags.forEach(tag => {
          const option = document.createElement('option');
          option.value = tag.id;
          option.textContent = tag.name;
          option.dataset.name = tag.name;
          tagSelector.appendChild(option);
        });
      })
      .catch(error => console.error('Erreur lors du chargement des tags:', error));
  }
  
  // Ajouter un tag sélectionné
  function addTag(id, name) {
    if (selectedTags.has(id)) return;
    
    selectedTags.add(id);
    updateTagsDisplay();
    updateHiddenInput();
  }
  
  // Supprimer un tag
  function removeTag(id) {
    selectedTags.delete(id);
    updateTagsDisplay();
    updateHiddenInput();
  }
  
  // Mettre à jour l'affichage des tags
  function updateTagsDisplay() {
    if (selectedTags.size === 0) {
      selectedTagsContainer.innerHTML = ``;
      selectedTagsContainer.classList.remove('has-tags');
    } else {
      const tagsHTML = Array.from(selectedTags).map(tagId => {
        const option = tagSelector.querySelector(`option[value="${tagId}"]`);
        const tagName = option ? option.dataset.name : tagId;
        return `
          <div class="selected-tag" data-id="${tagId}">
            <span>${tagName}</span>
            <button type="button" class="tag-remove" onclick="removeTagById('${tagId}')">
              ×
            </button>
          </div>
        `;
      }).join('');
      
      selectedTagsContainer.innerHTML = `<div class="tags-grid">${tagsHTML}</div>`;
      selectedTagsContainer.classList.add('has-tags');
    }
    
    // Mettre à jour le compteur
    tagCount.textContent = selectedTags.size;
  }
  
  // Mettre à jour l'input caché
  function updateHiddenInput() {
    const tagIds = Array.from(selectedTags);
    // Mettre à jour les options sélectionnées
    Array.from(hiddenTagsInput.options).forEach(option => {
      option.selected = tagIds.includes(option.value);
    });
  }
  
  // Fonction globale pour supprimer un tag
  window.removeTagById = function(id) {
    removeTag(id);
  };
  
  // Événements
  addSelectedTagBtn.addEventListener('click', function() {
    const selectedOption = tagSelector.options[tagSelector.selectedIndex];
    if (selectedOption.value) {
      addTag(selectedOption.value, selectedOption.dataset.name);
      tagSelector.selectedIndex = 0;
    }
  });
  
  createNewTagBtn.addEventListener('click', function() {
    const tagName = newTagInput.value.trim();
    if (tagName) {
      // Créer le nouveau tag
      fetch('/projects/api/tags/create/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({ name: tagName })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Ajouter à la liste déroulante
          const option = document.createElement('option');
          option.value = data.tag.id;
          option.textContent = data.tag.name;
          option.dataset.name = data.tag.name;
          tagSelector.appendChild(option);
          
          // Ajouter aux tags sélectionnés
          addTag(data.tag.id, data.tag.name);
          newTagInput.value = '';
        }
      })
      .catch(error => console.error('Erreur lors de la création du tag:', error));
    }
  });
  
  // Permettre la création avec Enter
  newTagInput.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      createNewTagBtn.click();
    }
  });
  
  // Initialisation des tags existants en mode édition
  {% if edit_mode and project.tags.all %}
  const existingTags = [
    {% for tag in project.tags.all %}
    { id: '{{ tag.id }}', name: '{{ tag.name }}' },
    {% endfor %}
  ];
  
  // Attendre que les tags soient chargés avant de les pré-sélectionner
  function initializeExistingTags() {
    existingTags.forEach(tag => {
      selectedTags.add(tag.id);
    });
    updateTagsDisplay();
    updateHiddenInput();
  }
  
  // Modifier la fonction loadExistingTags
  function loadExistingTags() {
    fetch('/projects/api/tags/all/')
      .then(response => response.json())
      .then(data => {
        tagSelector.innerHTML = '<option value="">Choisir un tag existant...</option>';
        data.tags.forEach(tag => {
          const option = document.createElement('option');
          option.value = tag.id;
          option.textContent = tag.name;
          option.dataset.name = tag.name;
          tagSelector.appendChild(option);
        });
        
        // Initialiser les tags existants après le chargement
        initializeExistingTags();
      })
      .catch(error => console.error('Erreur lors du chargement des tags:', error));
  }
  {% else %}
  function loadExistingTags() {
    fetch('/projects/api/tags/all/')
      .then(response => response.json())
      .then(data => {
        tagSelector.innerHTML = '<option value="">Choisir un tag existant...</option>';
        data.tags.forEach(tag => {
          const option = document.createElement('option');
          option.value = tag.id;
          option.textContent = tag.name;
          option.dataset.name = tag.name;
          tagSelector.appendChild(option);
        });
      })
      .catch(error => console.error('Erreur lors du chargement des tags:', error));
  }
  {% endif %}

  // Initialisation
  loadExistingTags();
});
</script>
  <script src="{% static 'projects/js/planning_calculator.js' %}"></script>
</body>
</html>
