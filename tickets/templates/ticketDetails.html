{% load static %}
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlowOps - Détails du Ticket</title>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?display=swap&family=Inter:wght@400;500;700;900&family=Noto+Sans:wght@400;500;700;900">
    <link rel="icon" type="image/x-icon" href="data:image/x-icon;base64,">
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <style>
        :root {
            --primary-color: #A08D80;
            --secondary-color: #D4CCC1;
            --text-color-dark: #3F3C3A;
            --text-color-medium: #6E6864;
            --text-color-light: #9C9591;
            --bg-light: #FBF9F7;
            --bg-white: #FFFFFF;
            --border-color: #EBE5E0;
            --status-active-bg: #EAE6DF;
            --status-active-text: #6E6864;
            --status-inactive-bg: #F7EAE3;
            --status-inactive-text: #A08D80;
            --nav-link-color: #191610;
            --nav-link-hover-bg: #f1efe9;
            --nav-link-active-bg: #f1efe9;
            --nav-link-active-color: #191610;
            --button-bg-light: #F0EDE9;
            --shadow-light: rgba(0, 0, 0, 0.03);
            --calendar-border: #EBE5E0;
            --calendar-header-bg: #FBF9F7;
            --calendar-day-name-color: #6E6864;
            --calendar-bg: #FFFFFF;
            --calendar-date-color: #191610;
            --flowops-blue: #4F46E5;
        }

        /* Styles généraux */
        body {
            font-family: 'Inter', 'Noto Sans', sans-serif;
            color: var(--text-color-dark);
        }

        /* Styles de la barre de navigation principale (header) */
        header {
            background-color: #f8f9fa;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        /* Styles pour les liens de navigation */
        .nav-link {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            color: var(--nav-link-color); /* Couleur par défaut */
            font-size: 0.875rem;
            font-weight: 500;
            border-radius: 9999px;
            transition: background-color 0.2s ease, color 0.2s ease;
            white-space: nowrap;
        }

        .nav-link:hover {
            background-color: var(--nav-link-hover-bg);
        }

        .nav-link-active {
            background-color: var(--nav-link-active-bg); /* Fond pour le lien actif */
            color: var(--nav-link-active-color); /* Texte pour le lien actif */
        }

        .nav-link-active:hover {
            background-color: var(--nav-link-active-bg); /* Maintenir le fond actif au survol */
            color: var(--nav-link-active-color); /* Maintenir le texte actif au survol */
        }

        /* Styles pour les statuts */
        .status-en-cours {
            color: var(--status-active-text);
            font-weight: normal;
        }

        .status-haute {
            color: var(--status-inactive-text); /* Couleur de texte pour "Haute" priorité */
            font-weight: normal;
        }

        /* Styles pour les commentaires */
        .comment-bubble {
            background-color: var(--bg-white);
            border-radius: 12px;
            padding: 1rem;
            box-shadow: 0 1px 3px var(--shadow-light);
            border: 1px solid var(--border-color);
        }

        .comment-avatar {
            min-width: 40px;
            min-height: 40px;
            max-width: 40px;
            max-height: 40px;
            border-radius: 9999px;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }

        .comment-input-container {
            background-color: var(--bg-white);
            border-radius: 12px;
            padding: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            border: 1px solid var(--border-color);
            box-shadow: 0 1px 3px var(--shadow-light);
        }

        .comment-input {
            flex-grow: 1;
            border: none;
            outline: none;
            padding: 0.5rem;
            font-size: 0.9rem;
            color: var(--text-color-dark);
            background-color: transparent;
        }

        .send-button {
            background-color: var(--primary-color);
            color: var(--bg-white);
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .send-button:hover {
            background-color: #8C7B71; /* Une teinte légèrement plus foncée */
        }

        .edit-button {
            background-color: transparent;
            color: #A08D80;
            border: 1px solid #A08D80;
            border-radius: 9999px;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            font-weight: 500;
            transition: background-color 0.2s ease;
        }
        .edit-button:hover {
            background-color: #F7EAE3;
        }
    </style>
    <style id="profile-dropdown-critical-styles">
        .profile-dropdown-menu { opacity: 0; visibility: hidden; transform: translateY(-10px); }
        .profile-dropdown-menu.show { opacity: 1; visibility: visible; transform: translateY(0); }
    </style>
</head>
<body class="relative flex size-full min-h-screen flex-col bg-[#fbfaf9] group/design-root overflow-x-hidden font-['Inter','Noto_Sans',sans-serif]">
    <div class="layout-container flex h-full grow flex-col">
        <div class="w-full px-6 py-2">
            <main class="layout-content-container flex flex-col max-w-full w-full flex-1">
                
                <!-- BARRE DE NAVIGATION PRINCIPALE -->
                <header class="flex flex-col px-10 py-3">
                    <div class="flex items-center justify-between whitespace-nowrap pb-3">
                        <div class="flex items-center gap-4 text-[#191610] flex-1">
                            <div class="size-4">
                                <svg viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M36.7273 44C33.9891 44 31.6043 39.8386 30.3636 33.69C29.123 39.8386 26.7382 44 24 44C21.2618 44 18.877 39.8386 17.6364 33.69C16.3957 39.8386 14.0109 44 11.2727 44C7.25611 44 4 35.0457 4 24C4 12.9543 7.25611 4 11.2727 4C14.0109 4 16.3957 8.16144 17.6364 14.31C18.877 8.16144 21.2618 4 24 4C26.7382 4 29.123 8.16144 30.3636 14.31C31.6043 8.16144 33.9891 4 36.7273 4C40.7439 4 44 12.9543 44 24C44 35.0457 40.7439 44 36.7273 44Z" fill="currentColor"></path></svg>
                            </div>
                            <h2 class="text-lg font-bold leading-tight tracking-[-0.015em] mr-6">FlowOps</h2>
                            <nav class="flex items-center gap-4">
                                <a href="/dashboard/" class="nav-link">Tableau de bord</a>
                                <a href="/ressources/" class="nav-link">Ressources</a>
                                <a href="/projects/" class="nav-link">Projets</a>
                                <a href="/tickets/" class="nav-link nav-link-active">Tickets</a>
                                {% if user.appRole == 'ADMIN' %}
                                <a href="/admin/password-resets/" class="nav-link">
                                    <span>Mots de passe</span>
                                </a>
                                {% endif %}
                            </nav>
                        </div>
                        <div class="flex items-center gap-8">
                            <label class="flex flex-col min-w-40 !h-10 max-w-64">
                                <div class="flex w-full flex-1 items-stretch rounded-xl h-full">
                                    <div class="text-[#8c7e5a] flex border-none bg-[#f1efe9] items-center justify-center pl-4 rounded-l-xl border-r-0">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256"><path d="M229.66,218.34l-50.07-50.06a88.11,88.11,0,1,0-11.31,11.31l50.06,50.07a8,8,0,0,0,11.32-11.32ZM40,112a72,72,0,1,1,72,72A72.08,72.08,0,0,1,40,112Z"></path></svg>
                                    </div>
                                    <input type="search" id="header-search-input-ticket-details" placeholder="Search" class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-xl text-[#191610] focus:outline-0 focus:ring-0 border-none bg-[#f1efe9] focus:border-none h-full placeholder:text-[#8c7e5a] px-4 rounded-l-none border-l-0 pl-2 text-base font-normal leading-normal">
                                </div>
                            </label>
                            <div class="profile-dropdown-container">
                                <div class="profile-picture bg-center bg-no-repeat aspect-square bg-cover rounded-full size-10" style='background-image: url("{% if user.gender == 'female' %}{% static 'Female.svg' %}{% else %}{% static 'Male.svg' %}{% endif %}")'></div>
                                <div class="profile-dropdown-menu">
                                    <a href="/ressources/details/{{ user.id }}" class="profile-dropdown-item">
                                        <svg class="profile-dropdown-icon" fill="currentColor" viewBox="0 0 24 24">
                                            <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                                        </svg>
                                        Voir Profil
                                    </a>
                                    <a href="#" class="profile-dropdown-item" onclick="window.profileDropdown.handleLogout(); return false;">
                                        <svg class="profile-dropdown-icon" fill="currentColor" viewBox="0 0 24 24">
                                            <path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.59L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/>
                                        </svg>
                                        Se déconnecter
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- BREADCRUMB -->
                    <div class="flex items-center gap-4 text-[#8c7e5a] text-sm font-medium">
                        <a href="/tickets/" class="hover:underline">Tickets</a>
                        <span>/</span>
                        <span>Détails du ticket</span>
                    </div>
                </header>
                
                <div class="px-10 py-6 flex flex-col gap-8">
                    <!-- En-tête du ticket -->
                    <div class="flex items-center justify-between">
                        <div class="flex flex-col">
                            <h1 class="text-[#191610] text-2xl font-bold leading-tight">{{ ticket.title }}</h1>
                            <p class="text-[#8c7e5a] text-base font-medium mt-2">Ticket #{{ ticket.id }} - Créé le {{ ticket.created_at|date:"d/m/Y" }}</p>
                        </div>
                        {% if can_edit %}
                        <div class="flex items-center gap-3">
                            <a href="{% url 'edit_ticket' ticket.id %}" class="edit-button">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16px" height="16px" fill="currentColor" viewBox="0 0 256 256">
                                    <path d="M227.31,73.37,182.63,28.69a16,16,0,0,0-22.63,0L36.69,152A15.86,15.86,0,0,0,32,163.31V208a16,16,0,0,0,16,16H92.69A15.86,15.86,0,0,0,104,219.31L227.31,96a16,16,0,0,0,0-22.63ZM92.69,208H48V163.31l88-88L180.69,120ZM192,108.69,147.31,64l24-24L216,84.69Z"></path>
                                </svg>
                                Éditer le ticket
                            </a>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Informations générales -->
                    <div class="flex flex-col gap-6">
                        <h2 class="text-[#191610] text-xl font-bold leading-tight tracking-tight">Informations générales</h2>
                        <div class="rounded-xl border border-[#e3dfd3] bg-[#fbfaf9] p-8 shadow-sm">
                            <div class="grid grid-cols-2 gap-8">
                                <!-- Colonne gauche -->
                                <div>
                                    <p class="text-[#8c7e5a] text-sm font-semibold mb-2 uppercase tracking-wide">Statut</p>
                                    <div class="mb-6">
                                        {% if can_edit %}
                                            <div class="inline-edit-container relative">
                                                <span id="status-display" class="inline-edit-badge rounded-full bg-[#f1efe9] px-3 py-1 text-sm font-medium text-[#191610] cursor-pointer hover:bg-[#e9e5db] transition-colors duration-200" 
                                                      data-field="status" data-value="{{ ticket.status }}" title="Click to edit">
                                                    {{ ticket.get_status_display }}
                                                    <svg class="inline w-3 h-3 ml-1 opacity-60" fill="currentColor" viewBox="0 0 20 20">
                                                        <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"></path>
                                                    </svg>
                                                </span>
                                                <select id="status-select" class="hidden inline-edit-select absolute top-0 left-0 rounded-full bg-white border border-[#d4ccc1] px-3 py-1 text-sm font-medium text-[#191610] focus:outline-none focus:ring-2 focus:ring-[#a08d80] focus:border-transparent">
                                                    <option value="Ouvert" {% if ticket.status == 'Ouvert' %}selected{% endif %}>Ouvert</option>
                                                    <option value="En cours" {% if ticket.status == 'En cours' %}selected{% endif %}>En cours</option>
                                                    <option value="Résolu" {% if ticket.status == 'Résolu' %}selected{% endif %}>Résolu</option>
                                                    <option value="Fermé" {% if ticket.status == 'Fermé' %}selected{% endif %}>Fermé</option>
                                                </select>
                                            </div>
                                        {% else %}
                                            <span class="rounded-full bg-[#f1efe9] px-3 py-1 text-sm font-medium text-[#191610]">{{ ticket.get_status_display }}</span>
                                        {% endif %}
                                    </div>
                                    
                                    <p class="text-[#8c7e5a] text-sm font-semibold mb-2 uppercase tracking-wide">Priorité</p>
                                    <div class="mb-6">
                                        {% if can_edit %}
                                            <div class="inline-edit-container relative">
                                                <span id="priority-display" class="inline-edit-badge rounded-full bg-[#f1efe9] px-3 py-1 text-sm font-medium text-[#191610] cursor-pointer hover:bg-[#e9e5db] transition-colors duration-200" 
                                                      data-field="priority" data-value="{{ ticket.priority }}" title="Click to edit">
                                                    {{ ticket.get_priority_display }}
                                                    <svg class="inline w-3 h-3 ml-1 opacity-60" fill="currentColor" viewBox="0 0 20 20">
                                                        <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"></path>
                                                    </svg>
                                                </span>
                                                <select id="priority-select" class="hidden inline-edit-select absolute top-0 left-0 rounded-full bg-white border border-[#d4ccc1] px-3 py-1 text-sm font-medium text-[#191610] focus:outline-none focus:ring-2 focus:ring-[#a08d80] focus:border-transparent">
                                                    <option value="Basse" {% if ticket.priority == 'Basse' %}selected{% endif %}>Basse</option>
                                                    <option value="Moyenne" {% if ticket.priority == 'Moyenne' %}selected{% endif %}>Moyenne</option>
                                                    <option value="Haute" {% if ticket.priority == 'Haute' %}selected{% endif %}>Haute</option>
                                                    <option value="Critique" {% if ticket.priority == 'Critique' %}selected{% endif %}>Critique</option>
                                                </select>
                                            </div>
                                        {% else %}
                                            <span class="rounded-full bg-[#f1efe9] px-3 py-1 text-sm font-medium text-[#191610]">{{ ticket.get_priority_display }}</span>
                                        {% endif %}
                                    </div>
                                    
                                    <p class="text-[#8c7e5a] text-sm font-semibold mb-2 uppercase tracking-wide">Créé par</p>
                                    <p class="text-[#191610] text-lg font-medium mb-6">{{ ticket.created_by.get_full_name }}</p>
                                    
                                    {% if ticket.project %}
                                    <p class="text-[#8c7e5a] text-sm font-semibold mb-2 uppercase tracking-wide">Projet</p>
                                    <p class="text-[#191610] text-lg font-medium">{{ ticket.project.name }}</p>
                                    {% endif %}
                                </div>
                                
                                <!-- Colonne droite -->
                                <div>
                                    <p class="text-[#8c7e5a] text-sm font-semibold mb-2 uppercase tracking-wide">Assigné à</p>
                                    <p class="text-[#191610] text-lg font-medium mb-6">
                                        {% if ticket.assigned_to.all %}
                                            {% for resource in ticket.assigned_to.all %}
                                                {{ resource.get_full_name }}{% if not forloop.last %}, {% endif %}
                                            {% endfor %}
                                        {% else %}
                                            Non assigné
                                        {% endif %}
                                    </p>
                                    
                                    <p class="text-[#8c7e5a] text-sm font-semibold mb-2 uppercase tracking-wide">Date de création</p>
                                    <p class="text-[#191610] text-lg font-medium mb-6">{{ ticket.created_at|date:"d/m/Y" }}</p>
                                    
                                    {% if ticket.due_date %}
                                    <p class="text-[#8c7e5a] text-sm font-semibold mb-2 uppercase tracking-wide">Date d'échéance</p>
                                    <p class="text-[#191610] text-lg font-medium">{{ ticket.due_date|date:"d/m/Y" }}</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Description du ticket -->
                    <div class="flex flex-col gap-4">
                        <h2 class="text-[#191610] text-lg font-bold leading-tight">Description</h2>
                        <div class="rounded-xl border border-[#e3dfd3] bg-[#fbfaf9] p-6">
                            <p class="text-[#191610] text-base leading-relaxed">{{ ticket.description }}</p>
                        </div>
                    </div>

                    <!-- Calendrier des activités du ticket -->
                    <div class="flex flex-col gap-4">
                        <h2 class="text-[#191610] text-lg font-bold leading-tight">Activités du ticket</h2>
                        <div class="rounded-xl border border-[#e3dfd3] bg-[#fbfaf9] p-6">
                            <div class="calendar-header">
                                <button id="prevMonthTicket" class="calendar-nav-button">◀</button>
                                <h3 id="month-year-display" class="text-xl font-semibold text-[#191610]">Mois Année</h3>
                                <div class="flex items-center gap-2">
                                    <button id="add-activity-btn" class="group relative px-6 py-3 bg-gradient-to-r from-[#a08d80]/90 to-[#8b7355]/90 backdrop-blur-md text-white rounded-2xl hover:from-[#8b7355]/95 hover:to-[#a08d80]/95 transition-all duration-300 transform hover:scale-105 hover:-translate-y-1 shadow-lg hover:shadow-2xl border border-white/20">
                                        <span class="flex items-center space-x-2">
                                            <svg class="w-5 h-5 transition-transform group-hover:rotate-90 duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                            </svg>
                                            <span class="font-medium">Ajouter une activité</span>
                                        </span>
                                        <div class="absolute inset-0 rounded-2xl bg-gradient-to-r from-white/10 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                                    </button>
                                    
                                    <button id="back-to-month" class="group relative px-6 py-3 bg-gradient-to-r from-[#a08d80]/90 to-[#8b7355]/90 backdrop-blur-md text-white rounded-2xl hover:from-[#8b7355]/95 hover:to-[#a08d80]/95 transition-all duration-300 transform hover:scale-105 hover:-translate-y-1 shadow-lg hover:shadow-2xl border border-white/20 hidden">
                                        <span class="flex items-center space-x-2">
                                            <svg class="w-5 h-5 transition-transform group-hover:-translate-x-1 duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                                            </svg>
                                            <span class="font-medium">Retour au mois</span>
                                        </span>
                                        <div class="absolute inset-0 rounded-2xl bg-gradient-to-r from-white/10 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                                    </button>
                                    <button id="nextMonthTicket" class="calendar-nav-button">▶</button>
                                </div>
                            </div>
                            
                            <!-- Member Legend -->
                            <div class="mb-4 p-4 bg-[#f8f6f3] rounded-xl border border-[#e3dfd3]">
                                <h3 class="text-[#191610] text-sm font-semibold mb-3 flex items-center">
                                    <svg class="w-4 h-4 mr-2 text-[#A08D80]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.196-2.121M17 20H7m10 0v-2c0-5.523-3.582-10-8-10s-8 4.477-8 10v2m8-10a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                    </svg>
                                    Membres assignés
                                </h3>
                                <div id="member-legend" class="flex flex-wrap gap-2">
                                    <!-- Member legend items will be populated by JavaScript -->
                                </div>
                            </div>
                            
                            <div id="calendar-container" class="calendar-container">
                                <div id="calendar-grid" class="calendar-grid">
                                    <!-- Les en-têtes des jours seront générés par JavaScript -->
                                </div>
                                <div id="day-view" class="day-view hidden">
                                    <div id="day-view-content" class="day-view-content">
                                        <!-- Le contenu de la vue journalière sera généré par JavaScript -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="flex flex-col gap-4">
                        <h2 class="text-[#191610] text-lg font-bold leading-tight">Commentaires du ticket</h2>
                        
                        <!-- Comments Section with Project-style UI -->
                        <div class="comments-section flex flex-col h-[calc(100vh-400px)] overflow-hidden rounded-xl border border-[#e3dfd3] bg-[#fbfaf9]">
                            <!-- Comments List -->
                            <div id="comments-container" class="comments-list flex-grow overflow-y-auto px-6 py-4">
                                {% if comments %}
                                    {% for comment in comments %}
                                        <div class="comment-item mb-4 group hover:bg-white p-4 rounded-lg transition-all duration-200 border border-[#e3dfd3] bg-white">
                                            <div class="comment-header flex justify-between items-center mb-2">
                                                <div class="comment-author flex items-center">
                                                    <div class="author-avatar bg-[#A08D80] text-white rounded-full w-8 h-8 flex items-center justify-center mr-3 shadow-sm">
                                                        {{ comment.author.first_name|first }}{{ comment.author.last_name|first }}
                                                    </div>
                                                    <div class="author-info">
                                                        <div class="author-name font-medium text-[#191610]">
                                                            {{ comment.author.get_full_name }}
                                                        </div>
                                                        <div class="author-role text-xs text-[#8c7e5a]">
                                                            {{ comment.author.role }}
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="comment-date text-xs text-[#8c7e5a] opacity-70 group-hover:opacity-100 transition-opacity">
                                                    {{ comment.created_at|date:"d/m/Y H:i" }}
                                                </div>
                                            </div>
                                            <div class="comment-content text-[#191610] mt-2 pl-11">
                                                {{ comment.content|linebreaks }}
                                            </div>
                                        </div>
                                    {% endfor %}
                                {% else %}
                                    <div id="no-comments-message" class="no-comments flex items-center justify-center h-full text-[#8c7e5a] text-sm">
                                        <p>Aucun commentaire pour ce ticket. Soyez le premier à commenter !</p>
                                    </div>
                                {% endif %}
                            </div>
                            
                            <!-- Comment Form -->
                            {% if can_comment %}
                            <div class="comment-form-container px-6 py-4 border-t border-[#e3dfd3] bg-white">
                                <form id="comment-form" class="comment-form flex items-center" onsubmit="return false;">
                                    {% csrf_token %}
                                    <div class="form-group flex-grow mr-3">
                                        <textarea id="comment-input" name="comment" class="w-full p-3 border border-[#e3dfd3] bg-white rounded-lg focus:outline-none focus:ring-2 focus:ring-[#A08D80] focus:border-transparent resize-none" rows="1" placeholder="Écrivez votre commentaire ici..."></textarea>
                                    </div>
                                    <div class="form-actions flex-shrink-0">
                                        <button type="submit" class="bg-[#A08D80] text-white p-3 rounded-full hover:bg-[#8a7a6e] transition-colors flex items-center justify-center w-10 h-10">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                                <path fill-rule="evenodd" d="M10.293 5.293a1 1 0 011.414 0l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414-1.414L12.586 11H5a1 1 0 110-2h7.586l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd" />
                                            </svg>
                                        </button>
                                    </div>
                                </form>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <style>
                        .comments-list::-webkit-scrollbar {
                            width: 4px;
                        }
                        .comments-list::-webkit-scrollbar-track {
                            background: transparent;
                        }
                        .comments-list::-webkit-scrollbar-thumb {
                            background-color: #eae6df;
                            border-radius: 20px;
                        }
                        .comments-list::-webkit-scrollbar-thumb:hover {
                            background-color: #d6d0c7;
                        }
                        textarea {
                            transition: all 0.2s ease;
                            background-color: #f9f8f7;
                        }
                        textarea:focus {
                            height: 80px;
                            background-color: white;
                        }
                                
                        /* Enhanced inline editing styles */
                        .inline-edit-container {
                            min-height: 32px; /* Ensure consistent height */
                        }
                                
                        .inline-edit-badge {
                            transition: all 0.2s ease;
                            font-weight: 600;
                            letter-spacing: 0.025em;
                        }
                                
                        .inline-edit-badge:hover {
                            transform: translateY(-1px);
                            box-shadow: 0 4px 12px rgba(160, 141, 128, 0.15);
                        }
                                
                        .inline-edit-select {
                            min-width: 120px;
                            transition: all 0.2s ease;
                            font-weight: 600;
                            letter-spacing: 0.025em;
                        }
                                
                        .inline-edit-select:focus {
                            transform: translateY(-1px);
                            box-shadow: 0 4px 12px rgba(160, 141, 128, 0.15);
                        }
                                
                        /* Enhanced badge styling with better typography */
                        .inline-edit-badge,
                        .inline-edit-select {
                            font-size: 0.875rem;
                            font-weight: 600;
                        }
                                
                        /* Edit button styling */
                        .edit-button {
                            display: inline-flex;
                            align-items: center;
                            justify-content: center;
                            gap: 0.5rem;
                            padding: 0.75rem 1.5rem;
                            background: linear-gradient(135deg, #A08D80, #D4CCC1);
                            color: white;
                            border: none;
                            border-radius: 12px;
                            font-size: 0.875rem;
                            font-weight: 600;
                            cursor: pointer;
                            transition: all 0.3s ease;
                            box-shadow: 0 3px 12px rgba(160, 141, 128, 0.25);
                            min-width: 140px;
                            text-decoration: none;
                            position: relative;
                            overflow: hidden;
                        }
                                
                        .edit-button:hover {
                            background: linear-gradient(135deg, #8C7B71, #A08D80);
                            transform: translateY(-2px) scale(1.02);
                            box-shadow: 0 6px 20px rgba(160, 141, 128, 0.35);
                        }
                                
                        .edit-button svg {
                            transition: transform 0.3s ease;
                        }
                                
                        .edit-button:hover svg {
                            transform: rotate(12deg) scale(1.05);
                        }
                    </style>

                </div>
            </main>
        </div>
    </div>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const commentForm = document.getElementById('comment-form');
        const commentInput = document.getElementById('comment-input');
        const commentsContainer = document.getElementById('comments-container');
        const noCommentsMessage = document.getElementById('no-comments-message');
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        // Function to scroll to the bottom of the comments container
        function scrollToBottom() {
            if (commentsContainer) {
                commentsContainer.scrollTop = commentsContainer.scrollHeight;
            }
        }
        
        // Scroll to bottom on page load if there are comments
        if (commentsContainer && commentsContainer.children.length > 0) {
            scrollToBottom();
        }
        
        if (commentForm) {
            // Auto-resize textarea as user types
            const textarea = document.getElementById('comment-input');
            if (textarea) {
                textarea.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = (this.scrollHeight) + 'px';
                });
            }
            
            commentForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const comment = textarea.value.trim();
                if (!comment) return;
                
                // Préparer les données pour l'envoi
                const data = JSON.stringify({
                    comment: comment
                });
                
                // Envoyer la requête AJAX
                fetch('{% url "add_comment_ajax" ticket.id %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': csrfToken
                    },
                    body: data
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        // Remove no comments message if it exists
                        if (noCommentsMessage) {
                            noCommentsMessage.remove();
                        }
                        
                        // Create the new comment element with project-style UI
                        const newComment = document.createElement('div');
                        newComment.className = 'comment-item mb-5 group hover:bg-[#f9f8f7] p-4 rounded-lg transition-all duration-200 border-b border-[#f1efe9]';
                        
                        // Get initials from author name
                        const nameParts = data.comment.author_name.split(' ');
                        const firstInitial = nameParts[0] ? nameParts[0].charAt(0) : '';
                        const lastInitial = nameParts[1] ? nameParts[1].charAt(0) : '';
                        const initials = firstInitial + lastInitial;
                        
                        // Format content with line breaks
                        const formattedContent = data.comment.content.replace(/\n/g, '<br>');
                        
                        // Build the comment HTML structure
                        newComment.innerHTML = `
                            <div class="comment-header flex justify-between items-center mb-2">
                                <div class="comment-author flex items-center">
                                    <div class="author-avatar bg-[#A08D80] text-white rounded-full w-8 h-8 flex items-center justify-center mr-3 shadow-sm">
                                        ${initials}
                                    </div>
                                    <div class="author-info">
                                        <div class="author-name font-medium text-[#191610]">
                                            ${data.comment.author_name}
                                        </div>
                                        <div class="author-role text-xs text-[#8c7e5a]">
                                            ${data.comment.author_role || 'Membre'}
                                        </div>
                                    </div>
                                </div>
                                <div class="comment-date text-xs text-[#8c7e5a] opacity-70 group-hover:opacity-100 transition-opacity">
                                    ${data.comment.created_at}
                                </div>
                            </div>
                            <div class="comment-content text-[#191610] mt-2 pl-11">
                                ${formattedContent}
                            </div>
                        `;
                        
                        // Add the comment to the container
                        commentsContainer.appendChild(newComment);
                        
                        // Scroll to the new comment
                        scrollToBottom();
                        
                        // Reset the form
                        textarea.value = '';
                        textarea.style.height = 'auto';
                    } else {
                        console.error('Erreur lors de l\'ajout du commentaire:', data.message);
                    }
                })
                .catch(error => {
                    console.error('Erreur lors de la requête AJAX:', error);
                });
            });
        }
    });
 </script>

<!-- Modal pour ajouter une activité -->
<div id="addActivityModal" class="fixed inset-0 bg-black bg-opacity-60 hidden z-50 flex items-center justify-center backdrop-blur-sm">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg mx-4 transform transition-all duration-300 scale-95 opacity-0 modal-content max-h-[90vh] overflow-hidden flex flex-col">
        <!-- En-tête du modal -->
        <div class="relative bg-gradient-to-r from-[#a08d80] to-[#8b7355] rounded-t-2xl p-6">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                    </svg>
                </div>
                <h3 class="text-xl font-bold text-white">Nouvelle Activité</h3>
            </div>
            <button id="closeAddActivityModal" class="absolute top-4 right-4 text-white hover:text-gray-200 transition-colors p-2 rounded-full hover:bg-white hover:bg-opacity-20">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        
        <!-- Corps du formulaire -->
        <div class="flex-1 overflow-y-auto">
            <form id="addActivityForm" class="p-6 space-y-6">
            {% csrf_token %}
            
            <!-- Titre -->
            <div class="space-y-2">
                <label for="activityTitle" class="flex items-center space-x-2 text-sm font-semibold text-[#191610]">
                    <svg class="w-4 h-4 text-[#a08d80]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    <span>Titre</span>
                </label>
                <input type="text" id="activityTitle" name="title" required 
                       placeholder="Ex: Réunion équipe, Développement feature..."
                       class="w-full px-4 py-3 border-2 border-[#e3dfd3] rounded-xl focus:ring-2 focus:ring-[#a08d80] focus:border-[#a08d80] transition-all duration-200 bg-[#fbfaf9] hover:border-[#a08d80]">
            </div>
            
            <!-- Date -->
            <div class="space-y-2">
                <label for="activityDate" class="flex items-center space-x-2 text-sm font-semibold text-[#191610]">
                    <svg class="w-4 h-4 text-[#a08d80]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                    </svg>
                    <span>Date</span>
                </label>
                <input type="date" id="activityDate" name="date" required 
                       class="w-full px-4 py-3 border-2 border-[#e3dfd3] rounded-xl focus:ring-2 focus:ring-[#a08d80] focus:border-[#a08d80] transition-all duration-200 bg-[#fbfaf9] hover:border-[#a08d80]">
            </div>
            
            <!-- Heures de début et fin -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="space-y-2">
                    <label for="startTime" class="flex items-center space-x-2 text-sm font-semibold text-[#191610]">
                        <svg class="w-4 h-4 text-[#a08d80]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span>Heure de début</span>
                    </label>
                    <input type="time" id="startTime" name="start_time" required 
                           class="w-full px-4 py-3 border-2 border-[#e3dfd3] rounded-xl focus:ring-2 focus:ring-[#a08d80] focus:border-[#a08d80] transition-all duration-200 bg-[#fbfaf9] hover:border-[#a08d80]">
                </div>
                <div class="space-y-2">
                    <label for="endTime" class="flex items-center space-x-2 text-sm font-semibold text-[#191610]">
                        <svg class="w-4 h-4 text-[#a08d80]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span>Heure de fin</span>
                    </label>
                    <input type="time" id="endTime" name="end_time" required 
                           class="w-full px-4 py-3 border-2 border-[#e3dfd3] rounded-xl focus:ring-2 focus:ring-[#a08d80] focus:border-[#a08d80] transition-all duration-200 bg-[#fbfaf9] hover:border-[#a08d80]">
                </div>
            </div>
            
            <!-- Description -->
             <div class="space-y-2">
                 <label for="activityDescription" class="flex items-center space-x-2 text-sm font-semibold text-[#191610]">
                     <svg class="w-4 h-4 text-[#a08d80]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7"></path>
                     </svg>
                     <span>Description</span>
                 </label>
                 <textarea id="activityDescription" name="description" rows="3" required
                           placeholder="Décrivez brièvement cette activité..."
                           class="w-full px-4 py-3 border-2 border-[#e3dfd3] rounded-xl focus:ring-2 focus:ring-[#a08d80] focus:border-[#a08d80] transition-all duration-200 bg-[#fbfaf9] hover:border-[#a08d80] resize-none"></textarea>
             </div>
             
             <!-- Type d'activité et Ressource liée -->
             <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                 <div class="space-y-2">
                     <label for="activityType" class="flex items-center space-x-2 text-sm font-semibold text-[#191610]">
                         <svg class="w-4 h-4 text-[#a08d80]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
                         </svg>
                         <span>Type d'activité</span>
                     </label>
                     <select id="activityType" name="type" required 
                             class="w-full px-4 py-3 border-2 border-[#e3dfd3] rounded-xl focus:ring-2 focus:ring-[#a08d80] focus:border-[#a08d80] transition-all duration-200 bg-[#fbfaf9] hover:border-[#a08d80]">
                         <option value="">Sélectionner un type</option>
                         <option value="meeting">Réunion</option>
                         <option value="development">Développement</option>
                         <option value="testing">Tests</option>
                         <option value="documentation">Documentation</option>
                         <option value="review">Révision</option>
                         <option value="support">Support</option>
                         <option value="other">Autre</option>
                     </select>
                 </div>
                 <div class="space-y-2">
                     <label for="linkedResource" class="flex items-center space-x-2 text-sm font-semibold text-[#191610]">
                         <svg class="w-4 h-4 text-[#a08d80]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path>
                         </svg>
                         <span>Ressource liée</span>
                     </label>
                     <select id="linkedResource" name="linked_resource" 
                             class="w-full px-4 py-3 border-2 border-[#e3dfd3] rounded-xl focus:ring-2 focus:ring-[#a08d80] focus:border-[#a08d80] transition-all duration-200 bg-[#fbfaf9] hover:border-[#a08d80]">
                         <option value="">Sélectionner une ressource</option>
                         <option value="project">Projet</option>
                         <option value="ticket">Ticket</option>
                     </select>
                 </div>
             </div>
             
             <!-- Liste dynamique des ressources -->
             <div id="resourceListContainer" class="space-y-2" style="display: none;">
                 <label for="specificResource" class="flex items-center space-x-2 text-sm font-semibold text-[#191610]">
                     <svg class="w-4 h-4 text-[#a08d80]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                     </svg>
                     <span id="resourceListLabel">Sélectionner</span>
                 </label>
                 <select id="specificResource" name="specific_resource" 
                         class="w-full px-4 py-3 border-2 border-[#e3dfd3] rounded-xl focus:ring-2 focus:ring-[#a08d80] focus:border-[#a08d80] transition-all duration-200 bg-[#fbfaf9] hover:border-[#a08d80]">
                     <option value="">Chargement...</option>
                 </select>
             </div>

            
            <!-- Boutons d'action -->
            <div class="flex flex-col sm:flex-row justify-end space-y-3 sm:space-y-0 sm:space-x-3 pt-6 border-t border-[#e3dfd3]">
                <button type="button" id="cancelAddActivity" 
                        class="px-6 py-3 text-[#191610] bg-[#f1efe9] rounded-xl hover:bg-[#e3dfd3] transition-all duration-200 font-medium border-2 border-transparent hover:border-[#e3dfd3] transform hover:scale-105">
                    <span class="flex items-center justify-center space-x-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                        <span>Annuler</span>
                    </span>
                </button>
                <button type="submit" 
                        class="px-6 py-3 bg-gradient-to-r from-[#a08d80] to-[#8b7355] text-white rounded-xl hover:from-[#8b7355] hover:to-[#a08d80] transition-all duration-200 font-medium shadow-lg hover:shadow-xl transform hover:scale-105">
                    <span class="flex items-center justify-center space-x-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                        <span>Créer l'activité</span>
                    </span>
                </button>
            </div>
         </form>
         </div>
     </div>
 </div>

<!-- Modal pour afficher les détails d'une activité -->
<div id="activityDetailsModal" class="fixed inset-0 bg-black bg-opacity-60 hidden z-50 flex items-center justify-center backdrop-blur-sm">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md mx-4 transform transition-all modal-content">
        <!-- En-tête du modal -->
        <div class="flex items-center justify-between p-6 border-b border-[#e3dfd3] bg-gradient-to-r from-[#fbfaf9] to-[#f5f3ee]">
            <h3 class="text-xl font-bold text-[#191610] flex items-center space-x-2">
                <svg class="w-5 h-5 text-[#a08d80]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <span>Détails de l'activité</span>
            </h3>
            <button id="closeActivityDetailsModal" class="text-[#a08d80] hover:text-[#8b7355] transition-colors p-2 rounded-full hover:bg-[#a08d80] hover:bg-opacity-10">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        
        <!-- Corps du modal -->
        <div class="p-6 space-y-4">
            <div class="space-y-3">
                <div>
                    <label class="text-sm font-semibold text-[#191610] block mb-1">Titre</label>
                    <p id="activityDetailTitle" class="text-[#191610] bg-[#fbfaf9] p-3 rounded-lg border border-[#e3dfd3]"></p>
                </div>
                
                <div>
                    <label class="text-sm font-semibold text-[#191610] block mb-1">Description</label>
                    <p id="activityDetailDescription" class="text-[#191610] bg-[#fbfaf9] p-3 rounded-lg border border-[#e3dfd3] min-h-[60px]"></p>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-sm font-semibold text-[#191610] block mb-1">Date de début</label>
                        <p id="activityDetailStartDate" class="text-[#191610] bg-[#fbfaf9] p-3 rounded-lg border border-[#e3dfd3] text-sm"></p>
                    </div>
                    <div>
                        <label class="text-sm font-semibold text-[#191610] block mb-1">Date de fin</label>
                        <p id="activityDetailEndDate" class="text-[#191610] bg-[#fbfaf9] p-3 rounded-lg border border-[#e3dfd3] text-sm"></p>
                    </div>
                </div>
                
                <div>
                    <label class="text-sm font-semibold text-[#191610] block mb-1">Assigné à</label>
                    <p id="activityDetailEmployee" class="text-[#191610] bg-[#fbfaf9] p-3 rounded-lg border border-[#e3dfd3]"></p>
                </div>
            </div>
        </div>
        
        <!-- Pied du modal avec boutons -->
        <div class="flex justify-between items-center p-6 border-t border-[#e3dfd3] bg-gradient-to-r from-[#fbfaf9] to-[#f5f3ee]">
            <button id="deleteActivityBtn" 
                    class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-all duration-200 font-medium shadow-md hover:shadow-lg transform hover:scale-105 flex items-center space-x-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                </svg>
                <span>Supprimer</span>
            </button>
            <button id="closeActivityDetailsBtn" 
                    class="px-4 py-2 bg-[#a08d80] text-white rounded-lg hover:bg-[#8b7355] transition-all duration-200 font-medium shadow-md hover:shadow-lg transform hover:scale-105">
                Fermer
            </button>
        </div>
    </div>
</div>

<style>
/* Animation d'ouverture du modal */
#addActivityModal:not(.hidden) .modal-content {
    animation: modalSlideIn 0.3s ease-out forwards;
}

@keyframes modalSlideIn {
    from {
        opacity: 0;
        transform: scale(0.9) translateY(-20px);
    }
    to {
        opacity: 1;
        transform: scale(1) translateY(0);
    }
}

/* Effet de focus amélioré pour les inputs */
#addActivityForm input:focus,
#addActivityForm textarea:focus {
    box-shadow: 0 0 0 3px rgba(160, 141, 128, 0.1);
}

/* Animation des labels */
#addActivityForm label {
    transition: all 0.2s ease;
}

#addActivityForm input:focus + label,
#addActivityForm textarea:focus + label {
    color: #a08d80;
}

/* Effet de survol sur les champs */
#addActivityForm input:hover,
#addActivityForm textarea:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(160, 141, 128, 0.1);
}

/* Styles de la barre de défilement personnalisée */
.modal-content .overflow-y-auto::-webkit-scrollbar {
    width: 8px;
}

.modal-content .overflow-y-auto::-webkit-scrollbar-track {
    background: #f1efe9;
    border-radius: 4px;
}

.modal-content .overflow-y-auto::-webkit-scrollbar-thumb {
    background: #a08d80;
    border-radius: 4px;
    transition: background 0.2s ease;
}

.modal-content .overflow-y-auto::-webkit-scrollbar-thumb:hover {
    background: #8b7355;
}

/* Assurer un défilement fluide */
.modal-content .overflow-y-auto {
    scroll-behavior: smooth;
}
</style>

</body>
</html>

<style>
/* Enhanced Calendar styles */
.calendar-container {
    position: relative;
    width: 100%;
    background-color: var(--bg-white);
    border-radius: 12px;
    overflow: visible;
    display: flex;
    flex-direction: column;
    padding: 1.5rem;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    border: 1px solid var(--calendar-border);
    max-width: 100%;
    margin-bottom: 2rem;
    min-height: 400px;
}

.calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 2px;
    border: 1px solid var(--border-color);
    border-radius: 0.5rem;
    overflow: hidden;
    background-color: var(--bg-light);
    margin-bottom: 0.5rem;
    width: 100%;
    min-height: 600px;
}

.calendar-day-header {
    font-weight: 600;
    color: var(--text-color-medium);
    text-align: center;
    padding: 1rem 0.5rem;
    background-color: var(--bg-light);
    font-size: 0.875rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.calendar-cell {
    background-color: var(--bg-light);
    min-height: 80px;
    height: auto;
    max-height: 120px;
    padding: 0.25rem 0.3rem 0.1rem 0.3rem;
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    position: relative;
    border-radius: 0.25rem;
    transition: box-shadow 0.15s;
    overflow: hidden;
    cursor: pointer;
}

.calendar-cell:hover {
    background-color: var(--bg-light);
    transform: scale(1.02);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    z-index: 10;
}

.calendar-cell.inactive {
    background-color: #f8f6f4;
    color: var(--text-color-light);
    cursor: default;
}

.calendar-cell.inactive:hover {
    transform: none;
    box-shadow: none;
    background-color: #f8f6f4;
}

.calendar-cell.today {
    background: linear-gradient(135deg, var(--primary-color), #8C7B71);
    color: var(--bg-white);
}

.calendar-cell.today .calendar-date {
    color: var(--bg-white);
    font-weight: 700;
}

.calendar-date {
    font-size: 1rem;
    font-weight: 600;
    color: var(--text-color-dark);
    margin-bottom: 0.5rem;
    align-self: flex-start;
}

.activities-container {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    width: 100%;
    flex-grow: 1;
}

.activity-item {
    padding: 0.375rem 0.5rem;
    border-radius: 6px;
    font-size: 0.75rem;
    font-weight: 500;
    cursor: pointer;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    position: relative;
    transition: all 0.2s ease;
    border-left: 3px solid transparent;
    backdrop-filter: blur(10px);
    box-shadow: 0 1px 3px rgba(160, 141, 128, 0.08);
}

.activity-item:hover {
    transform: translateX(2px) translateY(-1px);
    box-shadow: 0 3px 8px rgba(160, 141, 128, 0.15);
}

.activity-item.inprogress {
    background: rgba(160, 141, 128, 0.12);
    border-left-color: rgba(160, 141, 128, 0.7);
    color: #5D4E37;
}

.activity-item.completed {
    background: rgba(139, 115, 85, 0.1);
    border-left-color: rgba(139, 115, 85, 0.6);
    color: #4A3728;
}

.activity-item.planned {
    background: rgba(180, 165, 150, 0.08);
    border-left-color: rgba(180, 165, 150, 0.5);
    color: #6B5B4F;
}

/* Enhanced Activity Tooltip */
.activity-tooltip {
    position: absolute;
    top: 50%;
    left: calc(100% + 15px);
    transform: translateY(-50%);
    background: var(--bg-white);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 1rem;
    width: 280px;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transform: translateY(-50%) translateX(-10px);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    pointer-events: none;
}

.activity-item:hover .activity-tooltip {
    opacity: 1;
    visibility: visible;
    transform: translateY(-50%) translateX(0);
}

/* Arrow for tooltip */
.activity-tooltip::before {
    content: '';
    position: absolute;
    top: 50%;
    left: -8px;
    transform: translateY(-50%);
    border: 8px solid transparent;
    border-right-color: var(--bg-white);
}

.activity-tooltip::after {
    content: '';
    position: absolute;
    top: 50%;
    left: -9px;
    transform: translateY(-50%);
    border: 9px solid transparent;
    border-right-color: var(--border-color);
    z-index: -1;
}

.activity-tooltip-title {
    font-weight: 600;
    font-size: 0.9rem;
    color: var(--text-color-dark);
    margin-bottom: 0.5rem;
    line-height: 1.4;
}

.activity-tooltip-info {
    font-size: 0.8rem;
    color: var(--text-color-medium);
    margin-bottom: 0.375rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.activity-tooltip-info::before {
    content: '•';
    color: var(--primary-color);
    font-weight: bold;
}

.activity-tooltip-description {
    font-size: 0.8rem;
    color: var(--text-color-dark);
    line-height: 1.4;
    background-color: var(--bg-light);
    padding: 0.5rem;
    border-radius: 6px;
    border-left: 3px solid var(--primary-color);
}

.more-activities {
    font-size: 0.7rem;
    font-weight: 500;
    color: var(--text-color-medium);
    text-align: center;
    background-color: var(--bg-light);
    border-radius: 4px;
    padding: 0.25rem;
    border: 1px dashed var(--border-color);
    cursor: pointer;
    transition: all 0.2s ease;
}

.more-activities:hover {
    background-color: var(--primary-color);
    color: var(--bg-white);
    border-color: var(--primary-color);
}

/* Enhanced Day view styles */
.day-view {
    background-color: var(--bg-white);
    border-radius: 12px;
    padding: 1.5rem;
    width: 100%;
}



.day-view-content {
    display: grid;
    grid-template-columns: 80px 1fr;
    gap: 1rem;
    max-height: 500px;
    overflow-y: auto;
    padding-right: 0.5rem;
}

/* Custom scrollbar */
.day-view-content::-webkit-scrollbar {
    width: 6px;
}

.day-view-content::-webkit-scrollbar-track {
    background: var(--bg-light);
    border-radius: 3px;
}

.day-view-content::-webkit-scrollbar-thumb {
    background: var(--primary-color);
    border-radius: 3px;
}

.hour-label {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--text-color-medium);
    text-align: right;
    padding-right: 1rem;
    line-height: 3rem;
    position: sticky;
    top: 0;
    background-color: var(--bg-white);
}

.hour-activities {
    position: relative;
    min-height: 3rem;
    border-left: 2px solid var(--border-color);
    padding-left: 1rem;
    padding-bottom: 0.5rem;
}

.hour-activities::before {
    content: '';
    position: absolute;
    left: -4px;
    top: 1.5rem;
    width: 6px;
    height: 6px;
    background-color: var(--primary-color);
    border-radius: 50%;
}

.day-activity {
    position: relative;
    margin-bottom: 0.75rem;
    padding: 0.75rem;
    border-radius: 12px;
    font-size: 0.875rem;
    color: #5D4E37;
    cursor: pointer;
    transition: all 0.3s ease;
    border-left: 3px solid transparent;
    backdrop-filter: blur(10px);
    box-shadow: 0 2px 8px rgba(160, 141, 128, 0.1);
}

.day-activity:hover {
    transform: translateX(4px) translateY(-2px);
    box-shadow: 0 6px 20px rgba(160, 141, 128, 0.2);
}

.day-activity.inprogress {
    background: rgba(160, 141, 128, 0.15);
    border-left-color: rgba(160, 141, 128, 0.8);
    color: #5D4E37;
}

.day-activity.completed {
    background: rgba(139, 115, 85, 0.12);
    border-left-color: rgba(139, 115, 85, 0.7);
    color: #4A3728;
}

.day-activity.planned {
    background: rgba(180, 165, 150, 0.1);
    border-left-color: rgba(180, 165, 150, 0.6);
    color: #6B5B4F;
}

.day-activity-title {
    font-weight: 600;
    margin-bottom: 0.25rem;
    color: #5D4E37;
}

.day-activity-time {
    font-size: 0.75rem;
    opacity: 0.8;
    margin-bottom: 0.25rem;
    color: #8B7355;
}

.day-activity-description {
    font-size: 0.8rem;
    line-height: 1.4;
    opacity: 0.85;
    color: #6B5B4F;
}

.hidden {
    display: none;
}

/* Navigation improvements */
.calendar-nav-button {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background-color: var(--bg-light);
    color: var(--text-color-dark);
    border: 1px solid var(--border-color);
    cursor: pointer;
    transition: all 0.2s ease;
    font-weight: 600;
}

/* Masquer le bouton d'ajout d'activité en vue journalière */
.day-view:not(.hidden) ~ .calendar-header #add-activity-btn {
    display: none !important;
}

.calendar-nav-button:hover {
    background-color: var(--primary-color);
    color: var(--bg-white);
    transform: scale(1.05);
}

.calendar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    padding: 0 0.5rem;
}

/* Empty state for days with no activities */
.empty-day-message {
    text-align: center;
    color: var(--text-color-light);
    font-style: italic;
    font-size: 0.8rem;
    padding: 2rem;
}

/* Tooltip positioning adjustments for edge cases */
.calendar-cell:nth-child(7n) .activity-tooltip,
.calendar-cell:nth-child(7n-1) .activity-tooltip {
    left: auto;
    right: calc(100% + 15px);
    transform: translateY(-50%) translateX(10px);
}

.calendar-cell:nth-child(7n):hover .activity-tooltip,
.calendar-cell:nth-child(7n-1):hover .activity-tooltip {
    transform: translateY(-50%) translateX(0);
}

.calendar-cell:nth-child(7n) .activity-tooltip::before,
.calendar-cell:nth-child(7n-1) .activity-tooltip::before {
    left: auto;
    right: -8px;
    border-right-color: transparent;
    border-left-color: var(--bg-white);
}

.calendar-cell:nth-child(7n) .activity-tooltip::after,
.calendar-cell:nth-child(7n-1) .activity-tooltip::after {
    left: auto;
    right: -9px;
    border-right-color: transparent;
    border-left-color: var(--border-color);
}
</style>


<script>
document.addEventListener('DOMContentLoaded', function() {
  const calendarContainer = document.getElementById('calendar-container');
  const calendarGrid = document.getElementById('calendar-grid');
  const monthYearDisplay = document.getElementById('month-year-display');
  const prevMonthBtn = document.getElementById('prevMonthTicket');
  const nextMonthBtn = document.getElementById('nextMonthTicket');
  const backToMonthBtn = document.getElementById('back-to-month');
  const dayView = document.getElementById('day-view');
  const dayViewContent = document.getElementById('day-view-content');
  
  let currentDate = new Date();
  let selectedDay = null;
  let isMonthView = true;

  // Activités liées au ticket
  const today = new Date();
  
  // Initialiser sans événements système; les activités seront chargées via l'API
  let ticketEvents = [];
  const memberFilterStorageKey = 'ticket:{{ ticket.id }}:memberFilter';
  let selectedMemberIds = new Set(JSON.parse(localStorage.getItem(memberFilterStorageKey) || '[]'));
  const saveSelectedMembers = () => { try { localStorage.setItem(memberFilterStorageKey, JSON.stringify(Array.from(selectedMemberIds))); } catch (e) {} };
  const rerenderCurrentView = () => { if (isMonthView) { renderCalendar(); } else if (selectedDay) { showDayView(selectedDay); } };
  
  // Helper function to convert hex to RGB
  function hexToRgb(hex) {
    const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
    return result ? {
      r: parseInt(result[1], 16),
      g: parseInt(result[2], 16),
      b: parseInt(result[3], 16)
    } : null;
  }

  // Récupérer les activités depuis l'API
  fetch('/activities/ticket/{{ ticket.id }}/activities/')
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Ajouter les activités récupérées à notre liste d'événements
        data.activities.forEach(activity => {
          const startTime = new Date(activity.start);
          const endTime = new Date(activity.end);
          
          ticketEvents.push({
            id: activity.id, // Ajouter l'ID de l'activité
            date: startTime.toDateString(),
            name: activity.title,
            status: activity.status === 'completed' ? 'completed' : 'inprogress',
            description: `${activity.description}\nAssigné à: ${activity.employee || 'Non assigné'}`,
            employee: activity.employee || 'Non assigné',
            employee_id: activity.employee_id,
            employee_color: activity.employee_color,
            startTime: startTime,
            endTime: endTime
          });
        });
        
        // Populate member legend
        populateMemberLegend();
        
        // Mettre à jour le calendrier avec les nouvelles activités
        renderCalendar();
      } else {
        console.error('Erreur lors de la récupération des activités:', data.error);
      }
    })
    .catch(error => {
      console.error('Erreur lors de la récupération des activités:', error);
      renderCalendar(); // Render calendar even if API fails
    });

  // Function to populate member legend
  const populateMemberLegend = () => {
    const memberLegend = document.getElementById('member-legend');
    const uniqueMembers = new Map();
    
    // Collect unique members from ticket events
    ticketEvents.forEach(event => {
      if (event.employee_id && event.employee_color && event.employee) {
        uniqueMembers.set(event.employee_id, {
          name: event.employee,
          color: event.employee_color
        });
      }
    });
    
    // Clear existing legend
    memberLegend.innerHTML = '';
    
    // Add legend items for each unique member
    uniqueMembers.forEach((member, memberId) => {
      const legendItem = document.createElement('div');
      legendItem.className = 'flex items-center gap-2 px-3 py-2 bg-white rounded-lg border border-[#e3dfd3] shadow-sm';
      
      const colorDot = document.createElement('div');
      colorDot.className = 'w-3 h-3 rounded-full border border-gray-300';
      colorDot.style.backgroundColor = member.color;
      
      const memberName = document.createElement('span');
      memberName.className = 'text-sm font-medium text-[#191610]';
      memberName.textContent = member.name;
      
      legendItem.appendChild(colorDot);
      legendItem.appendChild(memberName);
      memberLegend.appendChild(legendItem);
    });
    
    // If no members found, show a message
    if (uniqueMembers.size === 0) {
      const noMembersMsg = document.createElement('div');
      noMembersMsg.className = 'text-sm text-[#8c7e5a] italic';
      noMembersMsg.textContent = 'Aucun membre assigné aux activités';
      memberLegend.appendChild(noMembersMsg);
    }
  };

  // Fonction pour générer le calendrier
  const renderCalendar = () => {
    calendarGrid.innerHTML = '';

    // Ajout des en-têtes des jours
    const dayNames = ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'];
    dayNames.forEach(day => {
      const dayHeader = document.createElement('div');
      dayHeader.className = 'calendar-day-header';
      dayHeader.textContent = day;
      calendarGrid.appendChild(dayHeader);
    });

    // Déterminer le premier jour du mois
    const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
    const startingDay = firstDay.getDay() || 7; // Convertir 0 (dimanche) en 7 pour le format européen

    // Déterminer le nombre de jours dans le mois
    const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
    const totalDays = lastDay.getDate();

    // Mettre à jour l'affichage du mois et de l'année
    const monthNames = ['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'];
    monthYearDisplay.textContent = `${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}`;

    // Ajouter les jours du mois précédent
    const prevMonthLastDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 0).getDate();
    for (let i = 1; i < startingDay; i++) {
      const day = prevMonthLastDay - startingDay + i + 1;
      const prevMonthDate = new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, day);
      addCalendarDay(day, prevMonthDate, true);
    }

    // Ajouter les jours du mois actuel
    for (let i = 1; i <= totalDays; i++) {
      const currentDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), i);
      const isToday = currentDay.toDateString() === today.toDateString();
      addCalendarDay(i, currentDay, false, isToday);
    }

    // Ajouter les jours du mois suivant pour compléter la grille
    const remainingCells = 42 - (startingDay - 1 + totalDays); // 42 = 6 semaines * 7 jours
    for (let i = 1; i <= remainingCells; i++) {
      const nextMonthDate = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, i);
      addCalendarDay(i, nextMonthDate, true);
    }
  };

  // Fonction pour ajouter un jour au calendrier
  const addCalendarDay = (day, currentDay, isInactive = false, isToday = false) => {
    const cell = document.createElement('div');
    cell.className = `calendar-cell ${isInactive ? 'inactive' : ''} ${isToday ? 'today' : ''}`;
    cell.dataset.date = currentDay.toISOString().split('T')[0]; // Stocker la date comme attribut de données
    
    // Ajouter la date et créer un conteneur pour les activités
    const dateSpan = document.createElement('span');
    dateSpan.className = 'calendar-date';
    dateSpan.textContent = day;
    
    const activitiesContainer = document.createElement('div');
    activitiesContainer.className = 'activities-container';
    
    cell.appendChild(dateSpan);
    cell.appendChild(activitiesContainer);
    
    // Ajouter un événement de clic pour afficher la vue journalière (seulement pour les jours actifs)
    if (!isInactive) {
      cell.addEventListener('click', () => {
        showDayView(currentDay);
      });
      cell.style.cursor = 'pointer';
    }
    
    calendarGrid.appendChild(cell);
    
    // Ajouter les événements pour ce jour
    const eventsForDay = ticketEvents.filter(event => new Date(event.date).toDateString() === currentDay.toDateString());
    
    // Trier les événements par heure de début
    eventsForDay.sort((a, b) => a.startTime - b.startTime);
    
    // Afficher jusqu'à 3 événements, avec un indicateur +plus s'il y en a plus
    const maxVisible = 3;
    const visibleEvents = eventsForDay.slice(0, maxVisible);
    
    visibleEvents.forEach(event => {
      const activityItem = document.createElement('div');
      activityItem.className = 'activity-item';
      activityItem.textContent = event.name;
      activityItem.style.cursor = 'pointer';
      
      // Apply member-specific color to the entire activity item
      if (event.employee_color) {
        activityItem.style.background = event.employee_color;
        activityItem.style.borderLeftColor = event.employee_color;
        activityItem.style.border = `2px solid ${event.employee_color}`;

        // Adjust text color based on background brightness
        const rgb = hexToRgb(event.employee_color);
        const brightness = (rgb.r * 299 + rgb.g * 587 + rgb.b * 114) / 1000;
        activityItem.style.color = brightness > 128 ? '#000000' : '#FFFFFF';
      } else {
        // Fallback to default styling
        activityItem.className += ` ${event.status}`;
      }
      
      // Ajouter un événement de clic pour ouvrir le modal de détails
      activityItem.addEventListener('click', (e) => {
        e.stopPropagation();
        showActivityDetails(event);
      });
      
      // Créer une infobulle pour le survol
      const tooltip = document.createElement('div');
      tooltip.className = 'activity-tooltip';
      
      const tooltipTitle = document.createElement('div');
      tooltipTitle.className = 'activity-tooltip-title';
      tooltipTitle.textContent = event.name;
      
      const tooltipTime = document.createElement('div');
      tooltipTime.className = 'activity-tooltip-info';
      const startTime = event.startTime.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
      const endTime = event.endTime.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
      tooltipTime.textContent = `${startTime} - ${endTime}`;
      
      // Calculer la durée en minutes
      const durationMs = event.endTime - event.startTime;
      const durationMinutes = Math.round(durationMs / 60000);
      const tooltipDuration = document.createElement('div');
      tooltipDuration.className = 'activity-tooltip-info';
      tooltipDuration.textContent = `Durée: ${durationMinutes} minutes`;
      
      const tooltipDescription = document.createElement('div');
      tooltipDescription.className = 'activity-tooltip-description';
      tooltipDescription.textContent = event.description;
      
      tooltip.appendChild(tooltipTitle);
      tooltip.appendChild(tooltipTime);
      tooltip.appendChild(tooltipDuration);
      tooltip.appendChild(tooltipDescription);
      
      activityItem.appendChild(tooltip);
      activitiesContainer.appendChild(activityItem);
    });
    
    // Ajouter l'indicateur 'plus' si nécessaire
    if (eventsForDay.length > maxVisible) {
      const moreIndicator = document.createElement('div');
      moreIndicator.className = 'more-activities';
      moreIndicator.textContent = `+${eventsForDay.length - maxVisible} plus`;
      moreIndicator.addEventListener('click', (e) => {
        e.stopPropagation();
        showDayView(currentDay);
      });
      activitiesContainer.appendChild(moreIndicator);
    }
  };
  
  // Fonction pour afficher la vue journalière avec toutes les activités pour un jour spécifique
  const showDayView = (date) => {
    selectedDay = date;
    isMonthView = false;
    
    // Masquer le bouton d'ajout d'activité en vue journalière
    const addActivityBtn = document.getElementById('add-activity-btn');
    if (addActivityBtn) {
      addActivityBtn.style.display = 'none';
    }
    
    // Mettre à jour l'en-tête du calendrier pour afficher le jour actuel
    const options = { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' };
    monthYearDisplay.textContent = date.toLocaleDateString('fr-FR', options);
    
    // Effacer le contenu précédent de la vue journalière
    dayViewContent.innerHTML = '';
    
    // Générer des créneaux horaires (8h à 20h)
    for (let hour = 8; hour <= 20; hour++) {
      const hourLabel = document.createElement('div');
      hourLabel.className = 'hour-label';
      hourLabel.textContent = `${hour}:00`;
      
      const hourActivities = document.createElement('div');
      hourActivities.className = 'hour-activities';
      hourActivities.dataset.hour = hour;
      
      dayViewContent.appendChild(hourLabel);
      dayViewContent.appendChild(hourActivities);
    }
    
    // Ajouter les activités à la vue journalière
    const dayActivities = ticketEvents.filter(event => 
      new Date(event.date).toDateString() === date.toDateString()
    );
    
    // Trier les activités par heure de début
    dayActivities.sort((a, b) => a.startTime - b.startTime);
    
    if (dayActivities.length === 0) {
      const emptyMessage = document.createElement('div');
      emptyMessage.className = 'empty-day-message';
      emptyMessage.textContent = 'Aucune activité prévue pour cette journée';
      dayViewContent.appendChild(emptyMessage);
    } else {
      // Ajouter les activités aux créneaux horaires appropriés
      dayActivities.forEach(activity => {
        const startHour = activity.startTime.getHours();
        const hourSlot = document.querySelector(`.hour-activities[data-hour="${startHour}"]`);
        
        if (hourSlot) {
          const activityEl = document.createElement('div');
          activityEl.className = 'day-activity';
          
          const startTime = activity.startTime.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
          const endTime = activity.endTime.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
          
          activityEl.innerHTML = `
            <div class="day-activity-title">${activity.name}</div>
            <div class="day-activity-time">${startTime} - ${endTime}</div>
            <div class="day-activity-description">${activity.description}</div>
          `;
          
          // Apply member-specific color to day view activities
          if (activity.employee_color) {
            activityEl.style.background = `${activity.employee_color}20`; // 20% opacity
            activityEl.style.borderLeftColor = activity.employee_color;
            activityEl.style.borderLeftWidth = '4px';

            // Adjust text color based on background brightness
            const rgb = hexToRgb(activity.employee_color);
            const brightness = (rgb.r * 299 + rgb.g * 587 + rgb.b * 114) / 1000;
            activityEl.style.color = brightness > 128 ? '#000000' : '#333333';
          } else {
            // Fallback to default styling
            activityEl.className += ` ${activity.status}`;
          }
          
          hourSlot.appendChild(activityEl);
        }
      });
    }
    
    // Afficher la vue journalière, masquer la vue mensuelle
    calendarGrid.classList.add('hidden');
    dayView.classList.remove('hidden');
    backToMonthBtn.classList.remove('hidden');
  };
  
  // Fonction pour revenir à la vue mensuelle
  const showMonthView = () => {
    isMonthView = true;
    calendarGrid.classList.remove('hidden');
    dayView.classList.add('hidden');
    backToMonthBtn.classList.add('hidden');
    
    // Réafficher le bouton d'ajout d'activité en vue mensuelle
    const addActivityBtn = document.getElementById('add-activity-btn');
    if (addActivityBtn) {
      addActivityBtn.style.display = 'block';
    }
    
    // Remettre l'affichage du mois et de l'année dans l'en-tête
    const monthNames = ['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'];
    monthYearDisplay.textContent = `${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}`;
  };

  // Navigation entre les mois/jours
  prevMonthBtn.addEventListener('click', () => {
    if (isMonthView) {
      currentDate.setMonth(currentDate.getMonth() - 1);
      renderCalendar();
    } else {
      const prevDay = new Date(selectedDay);
      prevDay.setDate(prevDay.getDate() - 1);
      showDayView(prevDay);
    }
  });
  
  nextMonthBtn.addEventListener('click', () => {
    if (isMonthView) {
      currentDate.setMonth(currentDate.getMonth() + 1);
      renderCalendar();
    } else {
      const nextDay = new Date(selectedDay);
      nextDay.setDate(nextDay.getDate() + 1);
      showDayView(nextDay);
    }
  });
  
  backToMonthBtn.addEventListener('click', () => {
    showMonthView();
  });

  // Initialiser le calendrier
  renderCalendar();
  
  // Gestion du modal d'ajout d'activité
  const addActivityBtn = document.getElementById('add-activity-btn');
  const addActivityModal = document.getElementById('addActivityModal');
  const closeAddActivityModal = document.getElementById('closeAddActivityModal');
  const cancelAddActivity = document.getElementById('cancelAddActivity');
  const addActivityForm = document.getElementById('addActivityForm');
  
  // Ouvrir le modal
  if (addActivityBtn) {
    addActivityBtn.addEventListener('click', () => {
      addActivityModal.classList.remove('hidden');
      // Masquer la barre de navigation
      const header = document.querySelector('header');
      if (header) {
        header.style.display = 'none';
      }
    });
  }
  
  // Fermer le modal
  if (closeAddActivityModal) {
    closeAddActivityModal.addEventListener('click', () => {
      addActivityModal.classList.add('hidden');
      // Restaurer la barre de navigation
      const header = document.querySelector('header');
      if (header) {
        header.style.display = '';
      }
    });
  }
  
  if (cancelAddActivity) {
    cancelAddActivity.addEventListener('click', () => {
      addActivityModal.classList.add('hidden');
      // Restaurer la barre de navigation
      const header = document.querySelector('header');
      if (header) {
        header.style.display = '';
      }
    });
  }
  
  // Fermer le modal en cliquant à l'extérieur
  if (addActivityModal) {
    addActivityModal.addEventListener('click', (e) => {
      if (e.target === addActivityModal) {
        addActivityModal.classList.add('hidden');
      }
    });
  }
  
  // Gérer la soumission du formulaire
  if (addActivityForm) {
    addActivityForm.addEventListener('submit', (e) => {
      e.preventDefault();
      
      const date = document.getElementById('activityDate').value;
      const startTime = document.getElementById('startTime').value;
      const endTime = document.getElementById('endTime').value;
      
      const formData = {
        title: document.getElementById('activityTitle').value,
        description: document.getElementById('activityDescription').value,
        start_datetime: `${date}T${startTime}:00`,
        end_datetime: `${date}T${endTime}:00`
      };
      
      // Envoyer les données à l'API
      fetch('/activities/ticket/{{ ticket.id }}/create/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify(formData)
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Ajouter la nouvelle activité à la liste des événements
          const newActivity = {
            date: new Date(formData.start_datetime).toDateString(),
            name: formData.title,
            status: 'planned',
            description: formData.description,
            startTime: new Date(formData.start_datetime),
            endTime: new Date(formData.end_datetime)
          };
          
          ticketEvents.push(newActivity);
          
          // Fermer le modal et rafraîchir le calendrier
          addActivityModal.classList.add('hidden');
          addActivityForm.reset();
          // Restaurer la barre de navigation
          const header = document.querySelector('header');
          if (header) {
            header.style.display = '';
          }
          renderCalendar();
          
          // Si on est en vue journalière, rafraîchir la vue
          if (!isMonthView && selectedDay) {
            showDayView(selectedDay);
          }
        } else {
          console.error('Erreur lors de la création de l\'activité:', data.error);
        }
      })
      .catch(error => {
        console.error('Erreur:', error);
      });
    });
  }
  
  // Gestion de la sélection dynamique des ressources
  const linkedResourceSelect = document.getElementById('linkedResource');
  const resourceListContainer = document.getElementById('resourceListContainer');
  const specificResourceSelect = document.getElementById('specificResource');
  const resourceListLabel = document.getElementById('resourceListLabel');
  
  if (linkedResourceSelect) {
    linkedResourceSelect.addEventListener('change', function() {
      const selectedType = this.value;
      
      if (selectedType === 'project' || selectedType === 'ticket') {
        // Afficher le conteneur de la liste
        resourceListContainer.style.display = 'block';
        
        // Mettre à jour le label
        if (selectedType === 'project') {
          resourceListLabel.textContent = 'Sélectionner un projet';
        } else {
          resourceListLabel.textContent = 'Sélectionner un ticket';
        }
        
        // Afficher "Chargement..." pendant la requête
        specificResourceSelect.innerHTML = '<option value="">Chargement...</option>';
        
        // Faire la requête AJAX pour récupérer les ressources
        fetch(`/tickets/get_resources/?type=${selectedType}`)
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              // Vider le select et ajouter les options
              specificResourceSelect.innerHTML = '<option value="">Sélectionner...</option>';
              
              data.resources.forEach(resource => {
                const option = document.createElement('option');
                option.value = resource.id;
                option.textContent = resource.title;
                specificResourceSelect.appendChild(option);
              });
            } else {
              specificResourceSelect.innerHTML = '<option value="">Erreur de chargement</option>';
              console.error('Erreur:', data.error);
            }
          })
          .catch(error => {
            specificResourceSelect.innerHTML = '<option value="">Erreur de chargement</option>';
            console.error('Erreur:', error);
          });
      } else {
        // Cacher le conteneur si aucune ressource n'est sélectionnée
        resourceListContainer.style.display = 'none';
      }
    });
  }
  
  // Fonction pour recharger les activités du ticket
  function loadTicketActivities() {
    // Réinitialiser les événements du ticket pour n'inclure que les activités utilisateur
    ticketEvents = [];
    
    // Récupérer les activités depuis l'API
    fetch('/activities/ticket/{{ ticket.id }}/activities/')
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Ajouter les activités récupérées à notre liste d'événements
          data.activities.forEach(activity => {
            const startTime = new Date(activity.start);
            const endTime = new Date(activity.end);
            
            ticketEvents.push({
              id: activity.id,
              date: startTime.toDateString(),
              name: activity.title,
              status: activity.status === 'completed' ? 'completed' : 'inprogress',
              description: `${activity.description}\nAssigné à: ${activity.employee || 'Non assigné'}`,
              employee: activity.employee || 'Non assigné',
              startTime: startTime,
              endTime: endTime
            });
          });
          
          // Mettre à jour le calendrier avec les nouvelles activités
          renderCalendar();
        } else {
          console.error('Erreur lors de la récupération des activités:', data.error);
        }
      })
      .catch(error => {
        console.error('Erreur lors de la récupération des activités:', error);
      });
  }
  
  // Variables globales pour le modal de détails d'activité
  let currentActivityId = null;
  const activityDetailsModal = document.getElementById('activityDetailsModal');
  const closeActivityDetailsModal = document.getElementById('closeActivityDetailsModal');
  const closeActivityDetailsBtn = document.getElementById('closeActivityDetailsBtn');
  const deleteActivityBtn = document.getElementById('deleteActivityBtn');
  
  // Fonction pour afficher les détails d'une activité
  function showActivityDetails(activity) {
    // Vérifier si l'activité a un ID (les événements système n'en ont pas)
    if (!activity.id) {
      alert('Cette activité ne peut pas être supprimée car elle fait partie des événements système.');
      return;
    }
    
    currentActivityId = activity.id;
    
    // Remplir les champs du modal avec les données de l'activité
    document.getElementById('activityDetailTitle').textContent = activity.name || 'Sans titre';
    document.getElementById('activityDetailDescription').textContent = activity.description || 'Aucune description';
    
    // Formater les dates
    const startDate = new Date(activity.startTime);
    const endDate = new Date(activity.endTime);
    
    const formatOptions = {
      day: '2-digit',
      month: '2-digit', 
      year: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    };
    
    document.getElementById('activityDetailStartDate').textContent = startDate.toLocaleDateString('fr-FR', formatOptions);
    document.getElementById('activityDetailEndDate').textContent = endDate.toLocaleDateString('fr-FR', formatOptions);
    document.getElementById('activityDetailEmployee').textContent = activity.employee || 'Non assigné';
    
    // Afficher le modal
    activityDetailsModal.classList.remove('hidden');
  }
  
  // Fonction pour fermer le modal de détails
  function closeActivityDetailsModalFunc() {
    activityDetailsModal.classList.add('hidden');
    currentActivityId = null;
  }
  
  // Événements pour fermer le modal
  if (closeActivityDetailsModal) {
    closeActivityDetailsModal.addEventListener('click', closeActivityDetailsModalFunc);
  }
  
  if (closeActivityDetailsBtn) {
    closeActivityDetailsBtn.addEventListener('click', closeActivityDetailsModalFunc);
  }
  
  // Fermer le modal en cliquant à l'extérieur
  if (activityDetailsModal) {
    activityDetailsModal.addEventListener('click', (e) => {
      if (e.target === activityDetailsModal) {
        closeActivityDetailsModalFunc();
      }
    });
  }
  
  // Fonction pour supprimer une activité
  if (deleteActivityBtn) {
    deleteActivityBtn.addEventListener('click', () => {
      if (!currentActivityId) {
        alert('Aucune activité sélectionnée');
        return;
      }
      
      if (confirm('Êtes-vous sûr de vouloir supprimer cette activité ?')) {
        fetch(`/activities/delete/${currentActivityId}/`, {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert('Activité supprimée avec succès');
            closeActivityDetailsModalFunc();
            // Recharger les activités
            loadTicketActivities();
          } else {
            alert('Erreur lors de la suppression: ' + data.message);
          }
        })
        .catch(error => {
          console.error('Erreur:', error);
          alert('Erreur lors de la suppression de l\'activité');
        });
      }
    });
  }
});

// Initialize Global Search
document.addEventListener('DOMContentLoaded', function() {
    new GlobalSearch('header-search-input-ticket-details');
});

// Inline Edit JavaScript for Tickets
class TicketInlineEditor {
    constructor() {
        this.init();
    }

    init() {
        // Add event listeners for all inline edit badges
        document.querySelectorAll('.inline-edit-badge').forEach(badge => {
            badge.addEventListener('click', (e) => this.startEdit(e));
        });

        // Add event listeners for all inline edit selects
        document.querySelectorAll('.inline-edit-select').forEach(select => {
            select.addEventListener('change', (e) => this.saveEdit(e));
            select.addEventListener('blur', (e) => this.cancelEdit(e));
            select.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    this.cancelEdit(e);
                }
            });
        });
    }

    startEdit(event) {
        const badge = event.currentTarget;
        const field = badge.dataset.field;
        const select = document.getElementById(`${field}-select`);
        
        if (select) {
            badge.classList.add('hidden');
            select.classList.remove('hidden');
            select.focus();
        }
    }

    cancelEdit(event) {
        const select = event.currentTarget;
        const field = select.id.replace('-select', '');
        const badge = document.getElementById(`${field}-display`);
        
        if (badge) {
            select.classList.add('hidden');
            badge.classList.remove('hidden');
            // Reset select to original value
            select.value = badge.dataset.value;
        }
    }

    async saveEdit(event) {
        const select = event.currentTarget;
        const field = select.id.replace('-select', '');
        const badge = document.getElementById(`${field}-display`);
        const newValue = select.value;
        const oldValue = badge.dataset.value;

        // Don't save if value hasn't changed
        if (newValue === oldValue) {
            this.cancelEdit(event);
            return;
        }

        try {
            // Show loading state
            select.disabled = true;
            
            const response = await fetch(`/tickets/api/update-field/{{ ticket.id }}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCsrfToken(),
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({
                    field: field,
                    value: newValue
                })
            });

            const data = await response.json();

            if (data.success) {
                // Update the badge
                badge.dataset.value = newValue;
                badge.innerHTML = `${data.display_value}
                    <svg class="inline w-3 h-3 ml-1 opacity-60" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"></path>
                    </svg>`;
                
                // Hide select and show badge
                select.classList.add('hidden');
                badge.classList.remove('hidden');
                
                // Show success toast
                this.showToast(data.message, 'success');
            } else {
                throw new Error(data.error || 'Failed to update');
            }
        } catch (error) {
            console.error('Error updating field:', error);
            this.showToast('Error updating ' + field + ': ' + error.message, 'error');
            // Reset to original value
            select.value = oldValue;
        } finally {
            select.disabled = false;
        }
    }

    getCsrfToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
               document.querySelector('meta[name=csrf-token]')?.getAttribute('content') ||
               document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1];
    }

    showToast(message, type = 'info') {
        // Create toast element
        const toast = document.createElement('div');
        toast.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 transition-all duration-300 transform translate-x-full ${
            type === 'success' ? 'bg-green-500 text-white' : 
            type === 'error' ? 'bg-red-500 text-white' : 
            'bg-blue-500 text-white'
        }`;
        toast.textContent = message;
        
        document.body.appendChild(toast);
        
        // Animate in
        setTimeout(() => {
            toast.classList.remove('translate-x-full');
        }, 100);
        
        // Animate out and remove
        setTimeout(() => {
            toast.classList.add('translate-x-full');
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 300);
        }, 3000);
    }
}

// Initialize ticket inline editor when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
    new TicketInlineEditor();
});
</script>

<!-- Global Search JavaScript -->
<script src="{% static 'projects/js/global_search.js' %}?v=2"></script>
<!-- Profile Dropdown JavaScript -->
<script src="{% static 'projects/js/profile_dropdown.js' %}"></script>
</body>
</html>